<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>A Data Engineering Perspective on Go vs. Python (Part 2 - Dataflow) - Vitthal Mirji</title><link rel=icon type=image/png href=favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="A Data Engineering Perspective on Go vs. Python (Part 2 - Dataflow)"><meta itemprop=description content="In Part 2 of our comparison of Python and go from a Data Engineering perspective, we'll finally take a look at Apache Beam and Google Dataflow and how the go SDK and the Python SDK differ, what drawbacks we're dealing with, how fast it is by running extensive benchmarks, and how feasible it is to make the switch"><meta itemprop=datePublished content="2020-07-06T00:00:00+00:00"><meta itemprop=dateModified content="2020-07-06T00:00:00+00:00"><meta itemprop=wordCount content="9168"><meta itemprop=keywords content="Go,Golang,Python,Dataflow,Beam,Google Cloud,Gcp,Spark,Big Data,Programming,Benchmarking,Performance"><meta property="og:url" content="https://vitthalmirji.com/2020/07/a-data-engineering-perspective-on-go-vs.-python-part-2-dataflow/"><meta property="og:site_name" content="Vitthal Mirji"><meta property="og:title" content="A Data Engineering Perspective on Go vs. Python (Part 2 - Dataflow)"><meta property="og:description" content="In Part 2 of our comparison of Python and go from a Data Engineering perspective, we'll finally take a look at Apache Beam and Google Dataflow and how the go SDK and the Python SDK differ, what drawbacks we're dealing with, how fast it is by running extensive benchmarks, and how feasible it is to make the switch"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-06T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Python"><meta property="article:tag" content="Dataflow"><meta property="article:tag" content="Beam"><meta property="article:tag" content="Google Cloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="A Data Engineering Perspective on Go vs. Python (Part 2 - Dataflow)"><meta name=twitter:description content="In Part 2 of our comparison of Python and go from a Data Engineering perspective, we'll finally take a look at Apache Beam and Google Dataflow and how the go SDK and the Python SDK differ, what drawbacks we're dealing with, how fast it is by running extensive benchmarks, and how feasible it is to make the switch"><link rel=stylesheet type=text/css media=screen href=https://vitthalmirji.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://vitthalmirji.com/css/main.css><link rel=stylesheet type=text/css href=https://vitthalmirji.com/[css/override.css]><link id=dark-scheme rel=stylesheet type=text/css href=https://vitthalmirji.com/css/dark.css><script src=https://vitthalmirji.com/js/feather.min.js></script><script src=https://vitthalmirji.com/js/main.js></script></head><body><div class="container-wide wrapper"><link rel=icon href=../../../favicon.ico sizes=any><link rel=icon type=image/png href=../../../favicon.png><link rel=apple-touch-icon href=../../../apple-touch-icon.png><link rel=manifest href=../../../site.webmanifest><meta name=theme-color content="#ffffff"><link rel=stylesheet href=../../../syntax.css><div class=header><h1 class=site-title><a href=https://vitthalmirji.com/>Vitthal Mirji</a></h1><div class=site-description><p>Software Engineering, Data Engineering, GNU/Linux, Data, ML, and other things</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/vim89/ title=Github><i data-feather=github></i></a></li><li><a href=https://twitter.com/whoami_vim/ title=Twitter><i data-feather=twitter></i></a></li><li><a href=https://www.linkedin.com/in/vitthal10/ title=LinkedIn><i data-feather=linkedin></i></a></li><li><a href=../../../index.xml title=RSS><i data-feather=rss></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=../../../>Home</a></li><li><a href=../../../about>About</a></li><li><a href=../../../tags>Tags & Stats</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>06</span>
<span class=rest>Jul 2020</span></div></div><div class=matter><h1 class=title>A Data Engineering Perspective on Go vs. Python (Part 2 - Dataflow)</h1></div></div><aside class=toc id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#apache-beam--google-dataflow>Apache Beam & Google Dataflow</a></li><li><a href=#why-beam-is-interesting>Why Beam is interesting</a></li><li><a href=#core-concepts>Core Concepts</a><ol><li><a href=#pipeline>Pipeline</a></li><li><a href=#pcollections>PCollections</a></li><li><a href=#transforms>Transforms</a></li><li><a href=#schemas>Schemas</a></li><li><a href=#io>I/O</a></li><li><a href=#runners>Runners</a></li></ol></li><li><a href=#the-use-case-for-a-sample-job>The Use Case for a Sample Job</a><ol><li><a href=#drawing-the-design>Drawing the design</a></li><li><a href=#getting-data>Getting data</a></li></ol></li><li><a href=#creating-the-pipeline>Creating the Pipeline</a><ol><li><a href=#python>Python</a></li><li><a href=#go>Go</a></li></ol></li><li><a href=#reading--parsing-data>Reading & Parsing Data</a><ol><li><a href=#python-1>Python</a></li><li><a href=#go-1>Go</a></li></ol></li><li><a href=#transforming-data>Transforming data</a><ol><li><a href=#python-2>Python</a></li><li><a href=#go-2>Go</a></li></ol></li><li><a href=#filtering-data>Filtering data</a><ol><li><a href=#python-3>Python</a></li><li><a href=#go-3>Go</a></li></ol></li><li><a href=#side-inputs-cogroupbykey-and-joins>Side Inputs, CoGroupByKey, and Joins</a></li><li><a href=#cogroupbykey-1>CoGroupByKey</a><ol><li><a href=#python-4>Python</a></li><li><a href=#go-4>Go</a></li></ol></li><li><a href=#side-inputs>Side Inputs</a><ol><li><a href=#python-5>Python</a></li><li><a href=#go-5>Go</a></li></ol></li><li><a href=#io-1>I/O</a><ol><li><a href=#python-6>Python</a></li><li><a href=#go-6>Go</a></li></ol></li><li><a href=#directrunner-locally>DirectRunner (locally)</a><ol><li><a href=#benchmarking>Benchmarking</a></li><li><a href=#a-reference-job>A Reference Job</a></li></ol></li><li><a href=#dataflow-google-cloud>Dataflow (Google Cloud)</a><ol><li><a href=#python-7>Python</a></li><li><a href=#dataflow-with-go>Dataflow with Go</a></li><li><a href=#registering-types-for-dataflow>Registering types for Dataflow</a></li><li><a href=#perf-tools---profiling-go>Perf Tools - Profiling <code>Go</code></a></li><li><a href=#a-journey-to-a-custom-coder>A journey to a custom coder</a></li><li><a href=#map---json---map>Map -> JSON -> Map</a></li><li><a href=#back-to-the-drawing-board>Back to the drawing board</a></li><li><a href=#finally-running-on-dataflow>Finally running on Dataflow</a></li><li><a href=#splittable-dofns>Splittable DoFns</a></li><li><a href=#dataflow-performance>Dataflow Performance</a></li><li><a href=#performance-summary>Performance Summary</a></li></ol></li><li><a href=#conclusion>Conclusion</a><ol><li><a href=#dynamic-vs-static-typing--dict-vs-struct>Dynamic vs. Static Typing & <code>dict</code> vs. <code>struct</code></a></li><li><a href=#compiler>Compiler</a></li><li><a href=#readability>Readability</a></li><li><a href=#splittable-dofns--performance>Splittable DoFns & Performance</a></li><li><a href=#documentation>Documentation</a></li><li><a href=#compatibility>Compatibility</a></li></ol></li><li><a href=#so-what>So What?</a></li></ol></nav></aside><h2 id=introduction>Introduction</h2><p>In Part 2 of our comparison of Python and go from a Data Engineering perspective, we&rsquo;ll finally take a look at Apache
Beam and Google Dataflow and how the go SDK and the Python SDK differ, what drawbacks we&rsquo;re dealing with, how fast it is
by running extensive benchmarks,and how feasible it is to make the switch.</p><blockquote><p>You can
find <a href=https://vitthalmirji.com/blog/2020/06/a-data-engineering-perspective-on-go-vs.-python-part-1/ target=_blank rel="nofollow noopener noreferrer">Part 1 here</a></p></blockquote><h2 id=apache-beam--google-dataflow>Apache Beam & Google Dataflow</h2><p>While we have used <a href=https://beam.apache.org/ target=_blank rel="nofollow noopener noreferrer">Apache Beam</a>
on several
occasions <a href=https://vitthalmirji.com/blog/2018/06/analyzing-reddits-top-posts-images-with-google-cloud-part-1/#introducing-data-flow target=_blank rel="nofollow noopener noreferrer">before</a>
,
allow me to give another short introduction.</p><blockquote><p>Apache Beam is an open source, unified model for defining both batch and streaming data-parallel processing pipelines.
Using one of the open source Beam SDKs, you build a program that defines the pipeline. The pipeline is then executed
by
one of Beam’s supported distributed processing back-ends, which include Apache Flink, Apache Spark, and Google Cloud
Dataflow.</p><p><a href=https://beam.apache.org/get-started/beam-overview/ target=_blank rel="nofollow noopener noreferrer">https://beam.apache.org/get-started/beam-overview/</a></p></blockquote><p>Beam can be used for a variety of data use cases, not unlike Apache Spark - ETL (Extract, Transform, Load) pipelines,
stream analytics, or simple data movement from, for instance, a file system to an RDMBS.</p><h2 id=why-beam-is-interesting>Why Beam is interesting</h2><p>One of the best professional advice I ever got is to ask &ldquo;So What?&rdquo;. That being said: So what, why do I care about Beam?</p><p>For me, one of the most interesting aspects of Beam&rsquo;s model is the decoupling of pipeline logic, language, and execution
environment. I can design my logic on a piece of paper (i.e., draw a <code>DAG</code> with some <code>Beam</code>-specific terminology - we&rsquo;ll
do that in a second), implement it in any of the major languages - even multiple - and run it on any of the supported
<code>Runners</code>.</p><p>The last time we used it on this blog, we used it to write a Pipeline to analyze reddit posts and executed it on the
<code>Dataflow</code> runner as such:</p><p><img src=images/dataflow-old.png alt=dataflow-old.png></p><p>As this pipeline was written in Python, there is nothing stopping us from running <em>the exact same job</em> on a on-premise
Hadoop cluster, on AWS EMR, or just run it locally using the <code>DirectRunner</code>. This level of portability, in combination
with a programming model that I happen to find more streamlined than say <code>Spark</code>&rsquo;s, makes <code>Beam</code> a very interesting
framework.</p><p>We&rsquo;ll actually do exactly that in the example section of this article and design a pipeline, write it in both <code>Python</code>
and <code>go</code>, and run it on different <code>Runners</code>.</p><h2 id=core-concepts>Core Concepts</h2><p>Everything in <code>Beam</code> starts with a <code>Pipeline.</code> The <code>Beam</code> programming model works by exposing high-level abstractions
through code that allow your <code>Pipeline</code> to execute a graph of <code>PTransforms</code> on a given dataset, which in term is
operating on immutable collections, called <code>PCollections</code>, which can be moved to a persistent state through <code>IO</code>
operations. Jobs can be executed on different <code>Runners</code> to provide a (distributed) execution environment.</p><p>Let&rsquo;s dig into those concepts before we look at a real-world example.</p><blockquote><p>This is a condensed version of
the <a href=https://beam.apache.org/documentation/programming-guide/ target=_blank rel="nofollow noopener noreferrer">official Apache Beam documentation</a>
, which I suggest
you
read in full for a more in-depth view</p></blockquote><h3 id=pipeline>Pipeline</h3><p>A <code>Pipeline</code> object is the starting point of any job, which is usually initialized with a <code>configuration</code> object that
defines <em>how</em> and <em>where</em> your pipeline runs.</p><h3 id=pcollections>PCollections</h3><p>A <code>PCollection</code>, not unlike a Spark <code>RDD</code> or <code>DataFrame</code>, are immutable collections of data that can be modified
in-memory through the lifecycle of a pipeline.</p><p>The data within a <code>PCollection</code> can be of any arbitrary type, as long as the elements can be encoded as <code>string</code> for
serializing them across the workers.</p><p><code>PCollections</code> can be of any size, but their elements might be worked on by different workers, if the collection is too
large to fit into memory on a single worker node. Furthermore, they can be either <em>bounded</em> (i.e., have a fixed size) or
<em>unbounded</em> (i.e., are &ldquo;open ended&rdquo;, like in a streaming scenario).</p><h3 id=transforms>Transforms</h3><p><code>Transforms</code> apply logic on individual elements of a <code>PCollection</code>, by <code>apply</code>ing user code and logic, and returning a
full <code>PCollection</code> that can be used in a subsequent step.</p><p><img src=images/design-your-pipeline-linear.svg alt></p><p>It is also possible to <code>branch</code> a pipeline, by splitting the DAG into multiple, independent steps:
<img src=images/design-your-pipeline-multiple-pcollections.svg alt>
(<a href=https://beam.apache.org/documentation/programming-guide/#applying-transforms target=_blank rel="nofollow noopener noreferrer">https://beam.apache.org/documentation/programming-guide/#applying-transforms</a>
)</p><p>Custom <code>transforms</code> need to adhere to some rules, most notably <strong>serializability</strong> (as data needs to be transmitted
between workers), <strong>single threaded execution</strong> (as each element should be worked on, as orchestrated by the underlying
Runner, in its own thread), and <strong>idempotence</strong> (as re-tries might occur).</p><p><code>Beam</code> provides several core <code>transforms</code> that can be utilized out-of-the-box:</p><ul><li><code>ParDo</code></li><li><code>GroupByKey</code></li><li><code>CoGroupByKey</code></li><li><code>Combine</code></li><li><code>Flatten</code></li><li><code>Partition</code></li></ul><h4 id=pardo>ParDo</h4><p>A <code>ParDo</code> transform is probably the most common one, as it is comparable to a <code>map</code> operation: Applying logic to each
element of a <code>PCollection</code> and returning said element (or not returning it and hence, <code>filtering</code> the collection).</p><p>Thing of <code>ParDo</code> as your fundamental building blog of a job that applies logic on a flat stream of data, which can then
be further enhanced by <code>grouping</code>, <code>flattening</code>, and other aggregation logic down the line.</p><p>To understand what a <code>ParDo</code> actually does, the <code>Beam</code> docs provide a great explanation of the lifecycle of a <code>ParDo</code>:</p><p><img src=images/dofn-sequence-diagram.svg alt></p><h4 id=cogroupbykey>CoGroupByKey</h4><p><code>CoGroupByKey</code> aggregates all input elements by their key over multiple input collections. CoGroupByKey performs a
relational join of two or more key/value PCollections that have the same key type - a very useful thing we&rsquo;ll be using
in the example below.</p><h3 id=schemas>Schemas</h3><p>A <code>Schema</code> defines the logical structure and data types for the elements within a <code>PCollection</code>. <code>Beam Schemas</code>, similar
to a <code>parquet</code> or <code>database</code> schema, should define <code>names</code>, <code>types</code>, and information on whether a field can be <code>NULL</code>.</p><p>Beam supports the following primitive types:</p><table><thead><tr><th style=text-align:center>Type</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:center>BYTE</td><td style=text-align:center>An 8-bit signed value</td></tr><tr><td style=text-align:center>INT16</td><td style=text-align:center>A 16-bit signed value</td></tr><tr><td style=text-align:center>INT32</td><td style=text-align:center>A 32-bit signed value</td></tr><tr><td style=text-align:center>INT64</td><td style=text-align:center>A 64-bit signed value</td></tr><tr><td style=text-align:center>DECIMAL</td><td style=text-align:center>An arbitrary-precision decimal type</td></tr><tr><td style=text-align:center>FLOAT</td><td style=text-align:center>A 32-bit IEEE 754 floating point number</td></tr><tr><td style=text-align:center>DOUBLE</td><td style=text-align:center>A 64-bit IEEE 754 floating point number</td></tr><tr><td style=text-align:center>STRING</td><td style=text-align:center>A string</td></tr><tr><td style=text-align:center>DATETIME</td><td style=text-align:center>A timestamp represented as milliseconds since the epoch</td></tr><tr><td style=text-align:center>BOOLEAN</td><td style=text-align:center>A boolean value</td></tr><tr><td style=text-align:center>BYTES</td><td style=text-align:center>A raw byte array</td></tr></tbody></table><h3 id=io>I/O</h3><p><code>I/O</code> is needed for providing input data and giving the pipeline one or multiple defined outputs. I will refer
to <a href=https://vitthalmirji.com/blog/2020/06/a-data-engineering-perspective-on-go-vs.-python-part-1/#io target=_blank rel="nofollow noopener noreferrer">Part 1</a>
for a
somewhat complete list of all <code>I/O</code> connectors by SDK.</p><p><code>I/O</code> connectors can also be customized, by inheriting from the existing Base classes to read non-supported file types.
This can be challenging (as you want to be able to split a file source so it can be worked on by multiple workers), but
after a while, becomes quite straightforward.</p><h3 id=runners>Runners</h3><p><code>Runners</code> define which system executes the pipeline, for instance by running locally (<code>DirectRunner</code>), on
<code>Google Dataflow</code>, or via <code>Apache Spark</code>.</p><p>Similar to <code>I/O</code>, please refer
to <a href=https://vitthalmirji.com/blog/2020/06/a-data-engineering-perspective-on-go-vs.-python-part-1/#runners target=_blank rel="nofollow noopener noreferrer">Part 1</a>
for an
overview.</p><h2 id=the-use-case-for-a-sample-job>The Use Case for a Sample Job</h2><p>In order to demonstrate some of the fundamental differences, let&rsquo;s define a sample use case that we can implement in
both <code>Python</code> and <code>go</code>.</p><p>In this example, we follow this simple user story: &ldquo;As a <em>movie enthusiast</em>, I want to <em>find movies that fit my
preferences</em>, so that <em>I can watch a new movie&rdquo;</em>.</p><p>Our <em>preferences</em> shall be:</p><ol><li>We want to parse both titles and ratings (<em>Reading data</em>)</li><li>We are only interested in movies, not TV shows; furthermore, movies should be made after 1970, to get some more
reliable metadata to base our decision on, as older titles often only have basic information (<em>Filtering data</em>)</li><li>We want both basic title as well as rating information from different sources (<em>Combining data</em>)</li><li>We want the data in a useable format (<em>Writing data</em>) [0]</li></ol><p>For this, we&rsquo;ll use the <a href=https://www.imdb.com/interfaces/ target=_blank rel="nofollow noopener noreferrer">IMDb DataSet</a>
, which can be utilized for non-commercial use
and is refreshed daily.</p><p><em>The full source code is available on <a href=https://github.com/vim89/beam-examples target=_blank rel="nofollow noopener noreferrer">GitHub</a>
.</em></p><p><em>[0] You might have gathered by now that these &ldquo;preferences&rdquo; are to demonstrate various <code>Beam</code> functionality - this is
not a fancy recommendation engine and we don&rsquo;t really care about the output</em></p><h3 id=drawing-the-design>Drawing the design</h3><p>As I&rsquo;ve said in the introduction, we can start by designing our pipeline first and then cover the language-specific
logic later.</p><p><img src=images/movie_flow.svg alt="Movie flow"></p><p>We have 2 main flows here, both of which do similar things: They read data, parse their format, and apply custom filters
to the data. Next, they are being combined into one coherent set and written to one or multiple I/O targets.</p><p>Let&rsquo;s so how to translate this into code.</p><h3 id=getting-data>Getting data</h3><p>If you agree with IMDb&rsquo;s license, you can find the data <a href=https://datasets.imdbws.com/ target=_blank rel="nofollow noopener noreferrer">here</a>
.</p><p>We&rsquo;ll start with the basic title data and make sure we start with a small test set, so we can develop locally without a
cluster. In order to do that, we&rsquo;ll grab random test data, as well as a movie we know fits our criteria, the 1971
classic &ldquo;Vanishing Point&rdquo;, with the id <code>tt0067927</code> (as it is unlikely we&rsquo;ll find more matches between the 2 data sets
we&rsquo;ll be using otherwise, given the volume).<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://datasets.imdbws.com/title.basics.tsv.gz <span class=o>&amp;&amp;</span> gunzip title.basics.tsv.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a small test file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>head -1 title.basics.tsv &gt; title.basics.100.tsv
</span></span><span class=line><span class=cl>shuf -n <span class=m>100</span> title.basics.tsv &gt;&gt; title.basics.100.tsv
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;tt0067927&#34;</span> title.basics.tsv &gt;&gt; title.basics.100.tsv</span></span></code></pre></td></tr></table></div></div></p><h4 id=titlebasics><code>title.basics</code></h4><p>This datasets contains basic title information as such and is a <em>564MB Tab Separated file</em>.</p><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>tconst</td><td>String</td><td>A unique ID</td></tr><tr><td>titleType</td><td>String</td><td>Type of title</td></tr><tr><td>primaryTitle</td><td>String</td><td>Popular title</td></tr><tr><td>originalTitle</td><td>String</td><td>Original title</td></tr><tr><td>isAdult</td><td>Integer</td><td>0: non adult; 1: adult</td></tr><tr><td>startYear</td><td>Integer</td><td>Release date of a title</td></tr><tr><td>endYear</td><td>Integer</td><td>End date; for TV shows</td></tr><tr><td>runtimeMinutes</td><td>Integer</td><td>Runtime in minutes</td></tr><tr><td>genres</td><td>Array<string></td><td>Genres</td></tr></tbody></table><p>We&rsquo;ll be using this to filter the majority of the records.</p><h4 id=titleratings><code>title.ratings</code></h4><p>This dataset contains ratings of all titles and is a <em>18MB Tab Separated file</em>.</p><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>tconst</td><td>String</td><td>A unique ID</td></tr><tr><td>averageRating</td><td>Float</td><td>Average rating</td></tr><tr><td>numVotes</td><td>Integer</td><td>Number of votes</td></tr></tbody></table><h2 id=creating-the-pipeline>Creating the Pipeline</h2><p>The first step in our Beam Pipeline is to create a skeleton code that creates the <code>Pipeline</code> object, parsing arguments,
and setting up a logger.</p><h3 id=python>Python</h3><p>We first need to install Beam by running <code>pip3 install --upgrade pip</code> and <code>pip3 install apache-beam==2.22.0 --upgrade</code>.</p><p>Our skeleton uses <code>Python</code>&rsquo;s standard <code>logger</code> module for logging and <code>argparse</code> to read arguments that will be passed
to the pipeline.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>absolute_import</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.io</span> <span class=kn>import</span> <span class=n>ReadFromText</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.io</span> <span class=kn>import</span> <span class=n>WriteToText</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span><span class=p>,</span> <span class=n>GoogleCloudOptions</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>SetupOptions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Parse arguments</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--input-ratings&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>dest</span><span class=o>=</span><span class=s1>&#39;input_ratings&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>help</span><span class=o>=</span><span class=s1>&#39;Input rating file to process.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--input-titles&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>dest</span><span class=o>=</span><span class=s1>&#39;input_titles&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>help</span><span class=o>=</span><span class=s1>&#39;Input title file to process.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--output&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>dest</span><span class=o>=</span><span class=s1>&#39;output&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>help</span><span class=o>=</span><span class=s1>&#39;Output to write results to.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>known_args</span><span class=p>,</span> <span class=n>pipeline_args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pipeline_options</span> <span class=o>=</span> <span class=n>PipelineOptions</span><span class=p>(</span><span class=n>pipeline_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pipeline_options</span><span class=o>.</span><span class=n>view_as</span><span class=p>(</span><span class=n>SetupOptions</span><span class=p>)</span><span class=o>.</span><span class=n>save_main_session</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create the pipeline</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO: Run it</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1>,</span><span class=si>%(msecs)d</span><span class=s1> </span><span class=si>%(levelname)-8s</span><span class=s1> [</span><span class=si>%(filename)s</span><span class=s1>:</span><span class=si>%(lineno)d</span><span class=s1>] </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>datefmt</span><span class=o>=</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>:%H:%M:%S&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run the core pipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Starting&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>run</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><p>There is not much else of note here - all of our pipeline code will be under the <code>with</code> block, which will define the
<code>DAG</code> we just designed once we wrote our individual steps.</p><h3 id=go>Go</h3><p>For <code>go</code>, we can install <code>beam</code> via <code>go get</code> as opposed to <code>pip</code> via <code>go get -u github.com/apache/beam/sdks/go/...</code></p><p>Next, our pipeline skeleton will use the <code>flags</code> package for arguments, as well as <code>log</code> for logging.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/apache/beam/sdks/go/pkg/beam&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/apache/beam/sdks/go/pkg/beam/io/textio&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/apache/beam/sdks/go/pkg/beam/x/beamx&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// Define arguments</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>inputBasePath</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;input-basics&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Input base file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>inputRatingsPath</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;input-ratings&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Input ratings file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>outputPath</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;output&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Output path&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Parse flags</span>
</span></span><span class=line><span class=cl><span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Initialize Beam</span>
</span></span><span class=line><span class=cl>	<span class=nx>beam</span><span class=p>.</span><span class=nf>Init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Input validation. Must be after Init().</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>*</span><span class=nx>inputBasePath</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=o>*</span><span class=nx>inputRatingsPath</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=o>*</span><span class=nx>outputPath</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Usage: movie_pipeline --input-basics $PATH, --input-ratings $PATH --output $PATH&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Create a Pipeline</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>NewPipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Root</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Pipeline code</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Concept #1: The beamx.Run convenience wrapper allows a number of</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pre-defined runners to be used via the --runner flag.</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>beamx</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>p</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to execute job: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>There are a couple noteworthy points here. First of, the <code>flags</code> package does not support mandatory attributes and as
such, we must check the String pointers passed by <code>flag.Parse()</code> manually. You will find similar blocks throughout the
code, as <code>go</code> does not know the concept of an <code>Exception</code> and therefore, errors are return elements (i.e., a function
might return a tuple of data and an optional error) and need to be checked against manually.</p><p>Furthermore, note how <code>beam.Init()</code> has to be called before the input validation.</p><h2 id=reading--parsing-data>Reading & Parsing Data</h2><p>Next, we need to read the data and parse the <code>TSV</code> format. We can use our first <code>ParDo</code> call to achieve this.</p><h3 id=python-1>Python</h3><p>First, let&rsquo;s define a <code>ParDo</code> operation by creating a subclass of <code>beam.DoFn</code> as such:</p><p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ParseCsv</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>col_names</span><span class=p>:</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>col_names</span> <span class=o>=</span> <span class=n>col_names</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>string</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>reader</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>DictReader</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>splitlines</span><span class=p>(),</span> <span class=n>fieldnames</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>col_names</span><span class=p>,</span> <span class=n>delimiter</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>reader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>row</span></span></span></code></pre></td></tr></table></div></div>This class will simply parse our CSV from rows of <code>str</code> into a <code>dict</code>, giving us <code>dict</code> as individual elements to work
with in the next <code>transforms</code>.</p><p>For a custom <code>ParDo</code>, the method <code>process</code> must be overwritten. <code>process</code> should be a <code>generator</code> and hence, has to
<code>yield</code> individual records. The function will be called <em>for each record in the <code>PCollection</code></em>. You will see what
happens if we use <code>return</code> instead of <code>yield</code> in a second.</p><p>Custom arguments can be passed to the class by overwriting the <code>constructor</code> in <code>__init__()</code>.</p><p>For integrating this with the pipeline, we need to define the flow. In the <code>Beam Python SDK</code>, the <code>>></code> and <code>|</code> operators
define our individual processing (<code>apply</code>) steps on top of a <code>PCollection</code>.</p><p>For each step, we can call <code>beam.ParDo</code> and provide an Instance of our <code>DoFn</code> subclass.</p><p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read data&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>ReadFromText</span><span class=p>(</span><span class=n>known_args</span><span class=o>.</span><span class=n>input_titles</span><span class=p>,</span> <span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Parse CSV&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=n>ParseCsv</span><span class=p>([</span><span class=s1>&#39;titleId&#39;</span><span class=p>,</span> <span class=s1>&#39;ordering&#39;</span><span class=p>,</span><span class=s1>&#39;title&#39;</span><span class=p>,</span><span class=s1>&#39;region&#39;</span><span class=p>,</span><span class=s1>&#39;language&#39;</span><span class=p>,</span><span class=s1>&#39;types&#39;</span><span class=p>,</span><span class=s1>&#39;attributes&#39;</span><span class=p>,</span><span class=s1>&#39;isOriginalTitle&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Print&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=nb>print</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div>This will read the Text file, parse the <code>TSV</code>, yield a <code>PCollection</code>, and use <code>map</code> to simply print the values.</p><p>The output looks like this:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;titleId&#39;</span>: <span class=s1>&#39;tt0000001&#39;</span>, <span class=s1>&#39;ordering&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;title&#39;</span>: <span class=s1>&#39;Карменсіта&#39;</span>, <span class=s1>&#39;region&#39;</span>: <span class=s1>&#39;UA&#39;</span>, <span class=s1>&#39;language&#39;</span>: <span class=s1>&#39;\\N&#39;</span>, <span class=s1>&#39;types&#39;</span>: <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>imdbDisplay&#39;</span>, <span class=s1>&#39;attributes&#39;</span>: <span class=s1>&#39;\\N&#39;</span>, <span class=s1>&#39;isOriginalTitle&#39;</span>: <span class=s1>&#39;0&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;titleId&#39;</span>: <span class=s1>&#39;tt0000001&#39;</span>, <span class=s1>&#39;ordering&#39;</span>: <span class=s1>&#39;2&#39;</span>, <span class=s1>&#39;title&#39;</span>: <span class=s1>&#39;Carmencita&#39;</span>, <span class=s1>&#39;region&#39;</span>: <span class=s1>&#39;DE&#39;</span>, <span class=s1>&#39;language&#39;</span>: <span class=s1>&#39;\\N&#39;</span>, <span class=s1>&#39;types&#39;</span>: <span class=s1>&#39;\\N&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>attributes&#39;</span>: <span class=s1>&#39;literal title&#39;</span>, <span class=s1>&#39;isOriginalTitle&#39;</span>: <span class=s1>&#39;0&#39;</span><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></p><p>This simple starting point shows the very specific syntax that <code>Beam</code> uses with <code>Python</code>. While it does create a clear,
readable logic, it certainly can be more confusing to read than a regular method-chaining approach.</p><h3 id=go-1>Go</h3><p>Here, we will probably see some of the most striking differences between <code>Python</code> and <code>go</code> - but as I&rsquo;ve found, also
evenly striking similarities.</p><p>Reading the data and applying the next <code>ParDo</code> does not follow <code>Python</code>&rsquo;s overloaded syntax (using <code>>></code> and <code>|</code>), <em>but
rather results in various <code>PCollections</code> returned after each step</em>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Parse the movies file</span>
</span></span><span class=line><span class=cl><span class=nx>lines_movies</span> <span class=o>:=</span> <span class=nx>textio</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>*</span><span class=nx>inputBasePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>base_movies</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>movieFn</span><span class=p>{},</span> <span class=nx>lines_movies</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><p>While this might look very different from <code>Python</code>, fundamentally, the same thing is happening: Every step of the graph
returns a <em>new <code>PCollection</code></em>, which can be worked on by the next step.</p><p>Another thing to mention here is the use of pointers. <code>*inputBasePath</code> is a pointer to the <code>flags</code> argument we gave
earlier. In <code>go</code>, a <code>*string</code> can be <code>nil</code>, whereas normal strings cannot (as <code>nil</code> in <code>go</code> means &ldquo;it does not point to
anything&rdquo;, whereas a <code>string</code> can only ever be empty or filled with characters - more on that below). <code>Python</code>, rather
famously, does not have exposed Pointers (and neither does <code>Java</code>, <code>Beam</code>&rsquo;s other major language).</p><p>The next seemingly very different thing is the actual <code>ParDo</code>. Let&rsquo;s break this down.</p><p><code>Beam</code>&rsquo;s generic <code>ParDo</code> function signature looks like this:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span> <span class=nx>Scope</span><span class=p>,</span> <span class=nx>dofn</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>col</span> <span class=nx>PCollection</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=nx>PCollection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>ret</span> <span class=o>:=</span> <span class=nf>MustN</span><span class=p>(</span><span class=nf>TryParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>dofn</span><span class=p>,</span> <span class=nx>col</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ret</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nb>panic</span><span class=p>(</span><span class=nf>formatParDoError</span><span class=p>(</span><span class=nx>dofn</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ret</span><span class=p>),</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>ret</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Where <code>s Scope</code> is your <code>pipeline</code> object, <code>dofn interface{}</code> uses <code>go</code>&rsquo;s <code>empty interface</code> logic to define an interface
that may hold values of any type (I&rsquo;ll get back to that in a second), and <code>col</code> is obviously our <code>PCollection</code>, similar
to what we saw in <code>Python</code>.</p><p>This means that <code>beam.ParDo(s, &amp;movieFn{}, lines_movies)</code> simply states: Apply the function <code>moveFn</code>, which has to be a
<code>ParDo</code> (remember: static typing!), and give it the <code>PCollection</code> called <code>line_movies</code> as an input.</p><p>Once you got over the syntax, this is very similar (if not to say, identical) to what happens with<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Parse CSV&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=n>ParseCsv</span><span class=p>([</span><span class=s1>&#39;titleId&#39;</span><span class=p>,</span> <span class=s1>&#39;ordering&#39;</span><span class=p>,</span><span class=s1>&#39;title&#39;</span><span class=p>,</span><span class=s1>&#39;region&#39;</span><span class=p>,</span><span class=s1>&#39;language&#39;</span><span class=p>,</span><span class=s1>&#39;types&#39;</span><span class=p>,</span><span class=s1>&#39;attributes&#39;</span><span class=p>,</span><span class=s1>&#39;isOriginalTitle&#39;</span><span class=p>]))</span></span></span></code></pre></td></tr></table></div></div></p><p>In Python.</p><p>We&rsquo;ll take a look at what <code>&amp;movieFn{}</code> does in the next section. In any case, at this point, we have a structured
representation of each row in the input <code>TSV</code>.</p><h2 id=transforming-data>Transforming data</h2><p>Next, we need to transform our data to make sure we have the right data types that we can use in our output and to make
sure our <code>filter</code> logic in the next steps is clear.</p><h3 id=python-2>Python</h3><p>Notice how <code>NULL</code> in the above output is referenced as <code>\N</code> and how <code>isOriginalTitle</code> sounds like a <code>boolean</code>, but is
actually an <code>integer</code>.</p><p>We can simply create another <code>ParDo</code> transformation to handle this scenario. In order to avoid a single <code>ParDo</code> class
for each file, we&rsquo;ll make it dynamic.<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CleanData</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bool_cols</span><span class=o>=</span><span class=p>[]):</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>bool_cols</span> <span class=o>=</span> <span class=n>bool_cols</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>record</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Map \N to None</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>N&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=c1># Convert e.g., `isOriginalTitle` to Boolean</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>bool_cols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;0&#39;</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=c1># Return</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>record</span></span></span></code></pre></td></tr></table></div></div></p><p>As <code>Python</code> <code>dicts</code> can accept arbitrary types, simply changing values within the dict is easy. Please note how we have
to treat <code>0</code> as a <code>string</code>, as <code>Python</code>, being dynamically typed, does not enforce the type here and given the TSV
input, everything is a <code>str</code>.</p><p>At this point, you might find yourself in one of two schools of thought: Either, you are happy that <code>Python</code> allows you
to write your Pipeline using <code>dicts</code> that do not care about their respective types (or even the number or names of
fields within the <code>dict</code>!) - which makes writing pipelines a lot easier.</p><p>Or, you are missing the strict typing that <code>Java</code> and <code>go</code> force. In both cases, we are actively forced to care about
structure and types before persisting any data anywhere, avoiding invalid conversions or wrong outputs into our target
system.</p><h3 id=go-2>Go</h3><p>For <code>go</code>, let&rsquo;s re-visit the <code>&amp;movieFn{}</code> argument from earlier.</p><p>We&rsquo;ve created a <code>struct</code> called <code>moveFn</code>, which holds the structure of our data and their types:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>movieFn</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>tconst</span><span class=p>,</span> <span class=nx>titleType</span><span class=p>,</span> <span class=nx>primaryTitle</span><span class=p>,</span> <span class=nx>originalTitle</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>isAdult</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=nx>startYear</span><span class=p>,</span> <span class=nx>endYear</span><span class=p>,</span> <span class=nx>runtimeMinutes</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>genres</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>We then define a <code>ParDo</code> method on this <code>struct</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>movieFn</span><span class=p>)</span> <span class=nf>ProcessElement</span><span class=p>(</span><span class=nx>line</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>movieFn</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>row</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;\t&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>row</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Skip the header</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>row</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s>&#34;tconst&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// Map nulls</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Convert the types</span>
</span></span><span class=line><span class=cl>		<span class=nx>startYear</span><span class=p>,</span> <span class=nx>err1</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>row</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>endYear</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>row</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>runtimeMinutes</span><span class=p>,</span> <span class=nx>err3</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>row</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Convert Boolean</span>
</span></span><span class=line><span class=cl>		<span class=nx>isAdultInt</span><span class=p>,</span> <span class=nx>err4</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>row</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>isAdult</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>isAdultInt</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>isAdult</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>isAdult</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err1</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err3</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err4</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If the types match, return a rating struct</span>
</span></span><span class=line><span class=cl>			<span class=nx>m</span> <span class=o>:=</span> <span class=nx>movieFn</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>tconst</span><span class=p>:</span>         <span class=nx>row</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>titleType</span><span class=p>:</span>      <span class=nx>row</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>primaryTitle</span><span class=p>:</span>   <span class=nx>row</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>originalTitle</span><span class=p>:</span>  <span class=nx>row</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>isAdult</span><span class=p>:</span>        <span class=nx>isAdult</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>startYear</span><span class=p>:</span>      <span class=nx>startYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>endYear</span><span class=p>:</span>        <span class=nx>endYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>runtimeMinutes</span><span class=p>:</span> <span class=nx>runtimeMinutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>genres</span><span class=p>:</span>         <span class=nx>row</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>emit</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Which combines both parsing the row and converting the types into a single <code>ParDo</code>. We&rsquo;ve split this up in Python to
explain the concepts, but fundamentally, the same thing happens: We need to split the line by the delimiter, a <code>tab</code>,
and create a <code>json</code> like structure (which is what this <code>struct</code> will be serialized to internally!).</p><p>In order to avoid having to deal with multiple <code>structs</code>, as we (as opposed to Python) cannot simply &ldquo;re-use&rdquo; the <code>dict</code>
and change the type[0], we are doing the conversion in a single step.</p><p>In the actual call to <code>ParDo</code>, <code>&amp;movieFn{}</code> simply translates to &ldquo;a reference to the memory location of the <code>movieFn</code>
struct, which is initialized as empty&rdquo;.</p><p>Last but not least, note how the return of the function is <code>emit func(movieFn))</code>. The <code>Beam</code> SDK uses reflection to
gather the type from the incoming and outgoing <code>PCollections</code>, in our case, an input as <code>line string</code> and output as
<code>movieFn</code> - by specifying a function as an <em>input</em>, which we then call similar to <code>Python</code>&rsquo;s native <code>yield</code>. Please note
how the actual function <em>does not return anything</em>, as the <code>emit</code> function is an argument to our <code>ParDo</code>!</p><p>You can call this function anything - <code>emit</code> is simply the style found in
the <a href=https://github.com/apache/beam/tree/master/sdks/go/examples target=_blank rel="nofollow noopener noreferrer">go examples</a>
.</p><p>It should be noted that this <code>struct</code> can of course also hold custom methods (similar to the <code>Python</code> class) by simply
providing more methods.</p><p>Let&rsquo;s re-visit the <code>string</code> and <code>nil</code> comment and try to convert <code>'\N'</code> to <code>nil</code> to match our <code>Python</code> pipeline,
assuming we want a <code>NULL</code> like type for writing data into e.g. <code>BigQuery</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>movieFn</span><span class=p>)</span> <span class=nf>CleanNulls</span><span class=p>(</span><span class=nx>row</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>nullColIds</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>row</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>row</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;\\N&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>row</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>row</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Which of course, the compiler doesn&rsquo;t accept:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cannot use nil as <span class=nb>type</span> string in assignment</span></span></code></pre></td></tr></table></div></div></p><p>One way around that is to either use <code>*string</code> or to follow, e.g. <a href=https://godoc.org/cloud.google.com/go/bigquery#InferSchema target=_blank rel="nofollow noopener noreferrer"><code>bigquery->InterSchema</code></a>
to map <code>NULL</code> to systems that
expect it for Strings.</p><p>Furthermore, we need to make sure we don&rsquo;t accidentally export this method, as otherwise, we&rsquo;ll get:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>graph.AsDoFn: unexpected exported method CleanNulls present. Valid methods are: <span class=o>[</span>Setup StartBundle ProcessElement
</span></span><span class=line><span class=cl>FinishBundle Teardown CreateInitialRestriction SplitRestriction RestrictionSize CreateTracker</span></span></code></pre></td></tr></table></div></div></p><p>Which can be fixed by simply not exporting it by starting the function with a lower-case &ldquo;c&rdquo;:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>movieFn</span><span class=p>)</span> <span class=nf>cleanNulls</span><span class=p>(</span><span class=nx>row</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>row</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>row</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;\\N&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>row</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>row</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>This is yet another difference to <code>Python</code>, as <code>go</code> ensures we follow the <code>interface</code> that is expected.</p><p>While I personally do think that the logic <code>go</code> imposes - a <code>String</code> is either empty or not, and having two different "
empty" types doesn&rsquo;t add much value - I can see this being very off-putting for somebody coming at <code>go</code> from a <code>Python</code>
or <code>Java</code> perspective.</p><p><em>[0] I assume we could use an <code>interface{}</code></em></p><h2 id=filtering-data>Filtering data</h2><p>Next, we want to filter the data to make sure we only get the movies and ratings we&rsquo;re after.</p><h3 id=python-3>Python</h3><p>Filtering data can be done by using yet another <code>ParDo</code> class, but with a catch. Let&rsquo;s try this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FilterBasicData</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;titleType&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;movie&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;isAdult&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=n>record</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=kc>None</span></span></span></code></pre></td></tr></table></div></div><p>The output looks unfortunate:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>None
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;tconst&#39;</span>: <span class=s1>&#39;tt3080844&#39;</span>, <span class=s1>&#39;titleType&#39;</span>: <span class=s1>&#39;movie&#39;</span>, <span class=s1>&#39;primaryTitle&#39;</span>: <span class=s1>&#39;Almost Holy&#39;</span>, <span class=s1>&#39;originalTitle&#39;</span>: <span class=s1>&#39;Crocodile Gennadiy&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>isAdult&#39;</span>: False, <span class=s1>&#39;startYear&#39;</span>: <span class=s1>&#39;2015&#39;</span>, <span class=s1>&#39;endYear&#39;</span>: None, <span class=s1>&#39;runtimeMinutes&#39;</span>: <span class=s1>&#39;96&#39;</span>, <span class=s1>&#39;genres&#39;</span>: <span class=s1>&#39;Biography,Documentary,Drama&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>None</span></span></code></pre></td></tr></table></div></div></p><p>If we, however, recall that <code>DoFn</code> is a generator (and not just a method that for some reason uses <code>yield</code> instead of
<code>return</code>), we can make quick use of that and simply <em>not return invalid records</em> (as well as add our other filter
criteria) and hence, create a smaller <code>PCollection</code> to work with:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FilterBasicData</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;titleType&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;movie&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;isAdult&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=n>record</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># No else - no yield</span></span></span></code></pre></td></tr></table></div></div></p><p>And get a decent looking output:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;tconst&#39;</span>: <span class=s1>&#39;tt3080844&#39;</span>, <span class=s1>&#39;titleType&#39;</span>: <span class=s1>&#39;movie&#39;</span>, <span class=s1>&#39;primaryTitle&#39;</span>: <span class=s1>&#39;Almost Holy&#39;</span>, <span class=s1>&#39;originalTitle&#39;</span>: <span class=s1>&#39;Crocodile Gennadiy&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>isAdult&#39;</span>: False, <span class=s1>&#39;startYear&#39;</span>: <span class=s1>&#39;2015&#39;</span>, <span class=s1>&#39;endYear&#39;</span>: None, <span class=s1>&#39;runtimeMinutes&#39;</span>: <span class=s1>&#39;96&#39;</span>, <span class=s1>&#39;genres&#39;</span>: <span class=s1>&#39;Biography,Documentary,Drama&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;tconst&#39;</span>: <span class=s1>&#39;tt7497202&#39;</span>, <span class=s1>&#39;titleType&#39;</span>: <span class=s1>&#39;movie&#39;</span>, <span class=s1>&#39;primaryTitle&#39;</span>: <span class=s1>&#39;Wonderful Losers: A Different World&#39;</span>, <span class=s1>&#39;originalTitle&#39;</span>: <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>Wonderful Losers: A Different World&#39;</span>, <span class=s1>&#39;isAdult&#39;</span>: False, <span class=s1>&#39;startYear&#39;</span>: <span class=s1>&#39;2017&#39;</span>, <span class=s1>&#39;endYear&#39;</span>: None, <span class=s1>&#39;runtimeMinutes&#39;</span>: <span class=s1>&#39;71&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>genres&#39;</span>: None<span class=o>}</span></span></span></code></pre></td></tr></table></div></div></p><p>But what about our filter by year? If we were to try <code>and record['startYear'] >= 1970:</code> as a condition, we&rsquo;re met with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>TypeError: <span class=s1>&#39;&gt;=&#39;</span> not supported between instances of <span class=s1>&#39;str&#39;</span> and <span class=s1>&#39;int&#39;</span> <span class=o>[</span><span class=k>while</span> running <span class=s1>&#39;Filter data&#39;</span><span class=o>]</span></span></span></code></pre></td></tr></table></div></div><p>Due to Python&rsquo;s lack of strict typing (remember how we did not define a schema anywhere). We can hotfix this by
extending <code>CleanData</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CleanData</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bool_cols</span><span class=o>=</span><span class=p>[],</span> <span class=n>int_cols</span><span class=o>=</span><span class=p>[]):</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>bool_cols</span> <span class=o>=</span> <span class=n>bool_cols</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>int_cols</span> <span class=o>=</span> <span class=n>int_cols</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>record</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Map \N to None</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>N&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=c1># Convert e.g., `isOriginalTitle` to Boolean</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>bool_cols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;0&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=c1># Force-parse numeric values</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>int_cols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=ow>and</span> <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>isdigit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=n>col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># Return</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>record</span></span></span></code></pre></td></tr></table></div></div><p>And adjust our filter to:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FilterBasicData</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;titleType&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;movie&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;isAdult&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;startYear&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;startYear&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>1970</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=n>record</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># No else - no yield</span></span></span></code></pre></td></tr></table></div></div></p><p>Which gives us a list of movies.</p><h3 id=go-3>Go</h3><p>Filtering here is not much different in <code>go</code>. We can make the same mistake as we did in <code>Python</code>, but confusing <code>return</code>
and (in this case) a <code>emit</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Filters Movies</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>filterMovies</span><span class=p>(</span><span class=nx>movie</span> <span class=nx>movieFn</span><span class=p>)</span> <span class=nx>movieFn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>movie</span><span class=p>.</span><span class=nx>isAdult</span> <span class=o>&amp;&amp;</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>startYear</span> <span class=o>&gt;=</span> <span class=mi>1970</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>movie</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>movieFn</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Which will return<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span> <span class=nb>false</span> <span class=m>0</span> <span class=m>0</span> <span class=m>0</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>tt3080844 movie Almost Holy Crocodile Gennadiy <span class=nb>false</span> <span class=m>2015</span> <span class=m>0</span> <span class=m>96</span> Biography,Documentary,Drama<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=nb>false</span> <span class=m>0</span> <span class=m>0</span> <span class=m>0</span> <span class=o>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Whereas the approach we discussed in the last section works:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Filters Movies</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>filterMovies</span><span class=p>(</span><span class=nx>movie</span> <span class=nx>movieFn</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>movieFn</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>movie</span><span class=p>.</span><span class=nx>isAdult</span> <span class=o>&amp;&amp;</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>startYear</span> <span class=o>&gt;=</span> <span class=mi>1970</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>movie</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Please note how we won&rsquo;t have any <code>TypeError: '>=' not supported between instances of 'str' and 'int'</code> type issues with
our statically typed <code>struct</code>s.</p><h2 id=side-inputs-cogroupbykey-and-joins>Side Inputs, CoGroupByKey, and Joins</h2><p>Due to the relational nature of the <code>IMDb</code> data, we will have to deal with multiple files to get all criteria we need.</p><p>There are two main ways of doing this: <code>Side Inputs</code>, if the data is small enough to comfortably fit in memory, or
<code>CoGroupByKey</code>, which is a much more expensive variant that will cause a <code>shuffle</code>.</p><p>We&rsquo;ll look at both, even though we only need one way of doing it.</p><p>Let&rsquo;s get the ratings data and grab a handful of records from the above output to ensure we&rsquo;ll have at least one match:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://datasets.imdbws.com/title.ratings.tsv.gz <span class=o>&amp;&amp;</span> gunzip title.ratings.tsv.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a small test file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>head -1 title.ratings.tsv &gt; title.ratings.100.tsv <span class=c1># header</span>
</span></span><span class=line><span class=cl>shuf -n <span class=m>100</span> title.ratings.tsv &gt;&gt; title.ratings.100.tsv
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;tt0067927&#34;</span> title.ratings.tsv &gt;&gt; title.ratings.100.tsv</span></span></code></pre></td></tr></table></div></div><h2 id=cogroupbykey-1>CoGroupByKey</h2><p>First, let&rsquo;s look at <code>CoGroupByKey</code>. This is often the more sensible option, unless one of the datasets is a lot smaller
in size and can be passed as in-memory <code>Side Input</code>.</p><h3 id=python-4>Python</h3><p>We can simply split our pipeline and this time, return a <code>PCollection</code> instead of passing it to <code>beam.Map(print)</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>basic_data</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read data&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>ReadFromText</span><span class=p>(</span><span class=n>known_args</span><span class=o>.</span><span class=n>input_basics</span><span class=p>,</span> <span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Parse CSV&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>ParseCsv</span><span class=p>(</span><span class=n>columns_title_basic</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Clean data&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>CleanData</span><span class=p>(</span><span class=n>bool_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;isAdult&#39;</span><span class=p>],</span> <span class=n>int_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;startYear&#39;</span><span class=p>,</span> <span class=s1>&#39;endYear&#39;</span><span class=p>,</span> <span class=s1>&#39;runtimeMinutes&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Filter data&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>FilterBasicData</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>As <code>side inputs</code> are not <code>PCollections</code>, we can transform the <code>ratings</code> one to a static <code>json</code> using <code>Map</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rating_data</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>ReadFromText</span><span class=p>(</span><span class=n>known_args</span><span class=o>.</span><span class=n>input_ratings</span><span class=p>,</span> <span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Parse CSV (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>ParseCsv</span><span class=p>(</span><span class=n>columns_ratings</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Clean data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>CleanData</span><span class=p>(</span><span class=n>int_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;numVotes&#39;</span><span class=p>],</span> <span class=n>float_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;averageRating&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Filter data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>FilterRatingData</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>rating_data</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>ReadFromText</span><span class=p>(</span><span class=n>known_args</span><span class=o>.</span><span class=n>input_ratings</span><span class=p>,</span> <span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=o>|</span> <span class=s1>&#39;Parse CSV (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>ParseCsv</span><span class=p>(</span><span class=n>columns_ratings</span><span class=p>))</span>
</span></span><span class=line><span class=cl>           <span class=o>|</span> <span class=s1>&#39;Clean data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>CleanData</span><span class=p>(</span><span class=n>int_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;numVotes&#39;</span><span class=p>],</span> <span class=n>float_cols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;averageRating&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>           <span class=o>|</span> <span class=s1>&#39;Filter data (Details)&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>FilterRatingData</span><span class=p>())</span>
</span></span><span class=line><span class=cl>         <span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><p>Once we have both <code>PCollections</code>, we can prepare the data for <code>CoGroupByKey</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Create keys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>movie_keys</span> <span class=o>=</span> <span class=p>(</span><span class=n>basic_data</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;movie key&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>r</span><span class=p>:</span> <span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>],</span> <span class=n>r</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#| &#39;Print&#39; &gt;&gt; beam.Map(print)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rating_keys</span> <span class=o>=</span> <span class=p>(</span><span class=n>rating_data</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;rating key&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>r</span><span class=p>:</span> <span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>],</span> <span class=n>r</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><p>And finally, apply the <code>CoGroupByKey</code> transform and <code>FlatMap</code> them together:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>joined_dicts</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;movie_keys&#39;</span><span class=p>:</span> <span class=n>movie_keys</span><span class=p>,</span> <span class=s1>&#39;rating_keys&#39;</span><span class=p>:</span> <span class=n>rating_keys</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>CoGroupByKey</span><span class=p>()</span>    
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>FlatMap</span><span class=p>(</span><span class=n>join_ratings</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;mergedicts&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>dd</span><span class=p>:</span> <span class=p>{</span><span class=o>**</span><span class=n>dd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>**</span><span class=n>dd</span><span class=p>[</span><span class=mi>1</span><span class=p>]})</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Print&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=nb>print</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><p>Yielding one record (as we chose our input randomly):<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;tconst&#39;</span>: <span class=s1>&#39;tt0067927&#39;</span>, <span class=s1>&#39;titleType&#39;</span>: <span class=s1>&#39;movie&#39;</span>, <span class=s1>&#39;primaryTitle&#39;</span>: <span class=s1>&#39;Vanishing Point&#39;</span>, <span class=s1>&#39;originalTitle&#39;</span>: <span class=s1>&#39;Vanishing Point&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>isAdult&#39;</span>: False, <span class=s1>&#39;startYear&#39;</span>: 1971, <span class=s1>&#39;endYear&#39;</span>: None, <span class=s1>&#39;runtimeMinutes&#39;</span>: 99, <span class=s1>&#39;genres&#39;</span>: <span class=s1>&#39;Action,Crime,Thriller&#39;</span>, <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>averageRating&#39;</span>: 7.2, <span class=s1>&#39;numVotes&#39;</span>: 25933<span class=o>}</span></span></span></code></pre></td></tr></table></div></div></p><h3 id=go-4>Go</h3><p>One thing you will notice is the lack of examples for these more &ldquo;advanced&rdquo; topics, such as <code>CoGroupByKey</code>, even though
they do in fact exist in the <a href=https://godoc.org/github.com/apache/beam/sdks/go/pkg/beam#CoGroupByKey target=_blank rel="nofollow noopener noreferrer">godocs</a>
.
Therefore, figuring this part out took quite a bit longer than I wanted it to, but it makes sense once the logic is
understood.</p><p>In order to use <code>CoGroupByKey</code>, we need to create a <code>KV</code> pair per <code>PCollection</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>extractRatingId</span><span class=p>(</span><span class=nx>r</span> <span class=nx>ratingFn</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=nx>ratingFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>extractMovieId</span><span class=p>(</span><span class=nx>m</span> <span class=nx>movieFn</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=nx>movieFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span> <span class=nx>m</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>And transform our collections:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Combine</span>
</span></span><span class=line><span class=cl><span class=nx>combined</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>CoGroupByKey</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>extractMovieId</span><span class=p>,</span> <span class=nx>filtered_movies</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>extractRatingId</span><span class=p>,</span> <span class=nx>filtered_ratings</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><p>And match them as follows:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>combineFn</span><span class=p>(</span><span class=nx>tconst</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>movieIter</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>movieFn</span><span class=p>)</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>ratingIter</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>ratingFn</span><span class=p>)</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// Pointers to structs</span>
</span></span><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>movieFn</span><span class=p>{</span><span class=nx>tconst</span><span class=p>:</span> <span class=nx>tconst</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ratingFn</span><span class=p>{</span><span class=nx>tconst</span><span class=p>:</span> <span class=nx>tconst</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// If match, emit</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nf>movieIter</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nf>ratingIter</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%v %v\n&#34;</span><span class=p>,</span> <span class=nx>tconst</span><span class=p>,</span> <span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span><span class=p>:</span>             <span class=nx>m</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span><span class=p>:</span>      <span class=nx>m</span><span class=p>.</span><span class=nx>titleType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span><span class=p>:</span>   <span class=nx>m</span><span class=p>.</span><span class=nx>primaryTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span><span class=p>:</span>  <span class=nx>m</span><span class=p>.</span><span class=nx>originalTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span><span class=p>:</span>        <span class=nx>m</span><span class=p>.</span><span class=nx>isAdult</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span><span class=p>:</span>      <span class=nx>m</span><span class=p>.</span><span class=nx>startYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span><span class=p>:</span>        <span class=nx>m</span><span class=p>.</span><span class=nx>endYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>runtimeMinutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span><span class=p>:</span>         <span class=nx>m</span><span class=p>.</span><span class=nx>genres</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span><span class=p>:</span>  <span class=nx>r</span><span class=p>.</span><span class=nx>averageRating</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span><span class=p>:</span>       <span class=nx>r</span><span class=p>.</span><span class=nx>numVotes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Note the <code>func(*movieFn) bool</code>, expecting a pointer to a <code>struct</code> that will tell us whether we have a match or not.</p><h2 id=side-inputs>Side Inputs</h2><p><code>Side Inputs</code> are a lot trickier than they seem in <code>go</code>, but relatively straightforward in <code>Python</code>.</p><h3 id=python-5>Python</h3><p>If we want to use <code>Side Inputs</code>, we can pass our smaller <code>ratings</code> <code>PCollection</code> as <code>list</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>joined_dicts</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=n>basic_data</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=s1>&#39;Join&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>JoinRatings</span><span class=p>(),</span> <span class=n>AsList</span><span class=p>(</span><span class=n>rating_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><p>To a new <code>ParDo</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>JoinRatings</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>movie</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>ratings_side</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>ratings_side</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>k</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>movie</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=p>{</span><span class=o>**</span><span class=n>movie</span><span class=p>,</span> <span class=o>**</span><span class=n>k</span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Or with a <code>AsDict</code> call[0]:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>JoinRatings</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>movie</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>ratings_side</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s1>&#39;tconst&#39;</span> <span class=ow>in</span> <span class=n>movie</span> <span class=ow>and</span> <span class=n>movie</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>]</span> <span class=ow>in</span> <span class=n>ratings_side</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=p>{</span><span class=o>**</span><span class=n>movie</span><span class=p>,</span> <span class=o>**</span><span class=n>ratings_side</span><span class=p>[</span><span class=n>movie</span><span class=p>[</span><span class=s1>&#39;tconst&#39;</span><span class=p>]]}</span></span></span></code></pre></td></tr></table></div></div></p><p>And get the same result, this time using a side input.</p><p><em>[0] A <code>dict</code> here would be a lot more efficient than a list; however, as far as I see it, the <code>go</code> SDK does not support
SideInputs as a <code>map</code>; I have therefore implemented both <code>Python</code> and <code>go</code> with <code>SideInputs</code> using both <code>lists</code>
and <code>maps</code>/<code>dicts</code>.</em></p><h3 id=go-5>Go</h3><p>We&rsquo;ll be <code>SideInput</code> here to highlight what I&rsquo;ve pointed out is possible in the <code>Python</code> section.</p><p>First, we need another Struct that will be our output structure:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>targetMovie</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=c1>// Ratings</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Note the values are <a href=https://golang.org/ref/spec#Exported_identifiers target=_blank rel="nofollow noopener noreferrer">exported</a>
, i.e. start with an Uppercase letter.</p><p>We simply define a <code>combine</code> type function that expects a <code>slice</code> or <code>ratingFn</code>, as opposed to a <code>PCollection</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>combineMoviesRatings</span><span class=p>(</span><span class=nx>movie</span> <span class=nx>movieFn</span><span class=p>,</span> <span class=nx>ratings</span> <span class=p>[]</span><span class=nx>ratingFn</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>r</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ratings</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>tconst</span> <span class=o>==</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span><span class=p>:</span>             <span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>titleType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span><span class=p>:</span>   <span class=nx>movie</span><span class=p>.</span><span class=nx>primaryTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span><span class=p>:</span>  <span class=nx>movie</span><span class=p>.</span><span class=nx>originalTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>isAdult</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>startYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>endYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span><span class=p>:</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>runtimeMinutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span><span class=p>:</span>         <span class=nx>movie</span><span class=p>.</span><span class=nx>genres</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span><span class=p>:</span>  <span class=nx>r</span><span class=p>.</span><span class=nx>averageRating</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span><span class=p>:</span>       <span class=nx>r</span><span class=p>.</span><span class=nx>numVotes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>And call it with a <code>Side Input</code> as such:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>combined</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>combineMoviesRatings</span><span class=p>,</span> <span class=nx>filtered_movies</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nx>SideInput</span><span class=p>{</span><span class=nx>Input</span><span class=p>:</span> <span class=nx>filtered_ratings</span><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>And with that, we get the same output:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;Id&#34;</span>:<span class=s2>&#34;tt0067927&#34;</span>,<span class=s2>&#34;TitleType&#34;</span>:<span class=s2>&#34;movie&#34;</span>,<span class=s2>&#34;PrimaryTitle&#34;</span>:<span class=s2>&#34;Vanishing Point&#34;</span>,<span class=s2>&#34;OriginalTitle&#34;</span>:<span class=s2>&#34;Vanishing Point&#34;</span>,<span class=s2>&#34;IsAdult&#34;</span>:
</span></span><span class=line><span class=cl>false,<span class=s2>&#34;StartYear&#34;</span>:1971,<span class=s2>&#34;EndYear&#34;</span>:0,<span class=s2>&#34;RuntimeMinutes&#34;</span>:99,<span class=s2>&#34;Genres&#34;</span>:<span class=s2>&#34;Action,Crime,Thriller&#34;</span>,<span class=s2>&#34;AverageRating&#34;</span>:7.2,<span class=s2>&#34;NumVotes&#34;</span>:
</span></span><span class=line><span class=cl>25933<span class=o>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Similar to what we&rsquo;ve seen in <code>Python</code>, doing this list comparison n times gives us O(n*n) and will be <em>tremendously</em>
ineffective.</p><p>As I still don&rsquo;t know whether the <code>go</code> SDK has an equivalent to <code>Python</code>&rsquo;s <code>apache_beam.pvalue.AsDict</code>, I&rsquo;ve came up
with this horrifying workaround that passes a single <code>PCollection</code> as Singleton SideInput to a <code>ParDo</code> and creates a
<code>map[string]ratingFn</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeRatingsMap</span><span class=p>(</span><span class=nx>rr</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>ratings</span> <span class=p>[]</span><span class=nx>ratingFn</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>r</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ratings</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>tconst</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>combineMoviesRatings</span><span class=p>(</span><span class=nx>movie</span> <span class=nx>movieFn</span><span class=p>,</span> <span class=nx>ratings</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ratings</span><span class=p>[</span><span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span><span class=p>:</span>             <span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>titleType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span><span class=p>:</span>   <span class=nx>movie</span><span class=p>.</span><span class=nx>primaryTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span><span class=p>:</span>  <span class=nx>movie</span><span class=p>.</span><span class=nx>originalTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>isAdult</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>startYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>endYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span><span class=p>:</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>runtimeMinutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span><span class=p>:</span>         <span class=nx>movie</span><span class=p>.</span><span class=nx>genres</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span><span class=p>:</span>  <span class=nx>r</span><span class=p>.</span><span class=nx>averageRating</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span><span class=p>:</span>       <span class=nx>r</span><span class=p>.</span><span class=nx>numVotes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Which we call as such:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Fake PCollection to only run the next parDo once</span>
</span></span><span class=line><span class=cl><span class=nx>fakePCol</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>CreateList</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// To Map</span>
</span></span><span class=line><span class=cl><span class=nx>filteredRatingsMap</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>makeRatingsMap</span><span class=p>,</span> <span class=nx>fakePCol</span><span class=p>,</span> <span class=nx>beam</span><span class=p>.</span><span class=nx>SideInput</span><span class=p>{</span><span class=nx>Input</span><span class=p>:</span> <span class=nx>filtered_ratings</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// And match</span>
</span></span><span class=line><span class=cl><span class=nx>combined</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>combineMoviesRatings</span><span class=p>,</span> <span class=nx>filtered_movies</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nx>SideInput</span><span class=p>{</span><span class=nx>Input</span><span class=p>:</span> <span class=nx>filteredRatingsMap</span><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>While this might fall under &ldquo;It&rsquo;s not stupid if it works!&rdquo;, we&rsquo;ll take a look at a lot of issues this caused when trying
to use <code>Dataflow</code> in a later section - note that this code does work on the <code>DirectRunner</code>, however.</p><h2 id=io-1>I/O</h2><p>Finally, let&rsquo;s write our data. We&rsquo;ll focus on writing to disk first.</p><h3 id=python-6>Python</h3><p>In <code>Python</code>, a simple call will create a <code>txt</code> file, containing the above <code>json</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>joined_dicts</span> <span class=o>|</span> <span class=s1>&#39;write&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>WriteToText</span><span class=p>(</span><span class=s1>&#39;./movies.txt&#39;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=go-6>Go</h3><p><code>Go</code> is once again very similar in that regard - we do, however, have to &ldquo;encode&rdquo; our <code>struct</code> as <code>JSON</code> in an inline
<code>ParDo</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>combinedString</span> <span class=o>:=</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>ParDo</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>v</span> <span class=nx>targetMovie</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>j</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>j</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=nx>combined</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Write</span>
</span></span><span class=line><span class=cl><span class=nx>textio</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>*</span><span class=nx>output</span><span class=p>,</span> <span class=nx>combinedString</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></p><h2 id=directrunner-locally>DirectRunner (locally)</h2><p>Let&rsquo;s run this and talk performance real quick. Last time, <code>go</code> was almost x45 faster than <code>Python</code> in our <code>Mandelbrot</code>
benchmark. Let&rsquo;s see how <code>Beam</code> holds up.</p><p>Comparing performance on the <code>DirectRunner</code> is almost a pointless exercise, as this runner is designed for local
debugging and development, not production use.</p><h3 id=benchmarking>Benchmarking</h3><p>That being said I did run some benchmarks, comparing <code>go</code> and <code>Python</code>, both using <code>Side Inputs</code> with <code>lists</code> or
<code>dicts</code>/<code>maps</code> respectively, as well as <code>CoGroupByKey</code>, using three different test data sets: 100 records @ ~9KB,
100,000 records @ ~9MB, and 1M records @ 100MB.</p><p>Looking at various <code>Side Inputs</code> first:
<img src=images/direct_num_workers_1_perf.png alt="Side Input DirectRunner Performance"></p><p><code>go</code> here is significantly faster, but that was expected due to this running essentially single-threaded. Using <code>lists</code>
as side inputs is a lot slower, to the point where I&rsquo;ve given up trying to run the <code>as list</code> use case for <code>go</code> and
<code>Python</code> at 1M records.</p><p>Now, for <code>CoGroupByKey</code>:
<img src=images/direct_num_workers_cogroup_perf.png alt="CoGroupByKey DirectRunner Performance"></p><p>Where we see a very similar trend with <code>go</code> being orders of magnitude faster. Impressive!</p><h3 id=a-reference-job>A Reference Job</h3><p>I&rsquo;ve also benchmarked the <code>wordcount</code> example with the <code>title.basics</code> data on the <code>DirectRunner</code> to ensure I did not
compare apples to oranges by writing fundamentally different code by accident.</p><p>I did this in <code>go</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go install github.com/apache/beam/sdks/go/examples/wordcount
</span></span><span class=line><span class=cl><span class=nb>time</span> wordcount --input ~/workspace/beam-examples/data/title.basics.tsv --output countsgo.txt</span></span></code></pre></td></tr></table></div></div></p><p>And <code>python</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>time</span> python3 -m apache_beam.examples.wordcount --input ~/workspace/beam-examples/data/title.basics.tsv --output
</span></span><span class=line><span class=cl>wordcountpy.txt <span class=c1># without multiple workers</span></span></span></code></pre></td></tr></table></div></div></p><p>Which yielded:</p><p><img src=images/direct_runner_full.png alt></p><p>Which does fall in line with our observation that, <code>Beam</code> with <code>go</code> is still a fair bit faster than <code>Python</code>.</p><h2 id=dataflow-google-cloud>Dataflow (Google Cloud)</h2><p>Now, running this on an external runner only leaves us with one option (as <code>go</code> doesn&rsquo;t support other runners),
<code>Google Cloud</code>&rsquo;s <code>Dataflow</code>. I should add that the <code>Dataflow</code> for <code>go</code> is still in version <code>0.5</code> and not officially
supported yet.</p><p>Ensure that you have:</p><ol><li>A Google Cloud Project</li><li>Billing enabled (or a Free-Tier eligible account)</li><li>DataFlow APIs enabled</li><li><code>gcloud sdk</code> installed, ran <code>gcloud init</code>, and <code>gcloud auth login</code></li><li><code>GOOGLE_APPLICATION_CREDENTIALS</code> is set</li><li>If you are reading this at Google, ensure Christian gets more free credits <em>(optional step)</em></li></ol><h3 id=python-7>Python</h3><p>For <code>Python</code>, we need to run it with an authenticated <code>gcloud sdk</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pip3</span> <span class=n>install</span> <span class=o>--</span><span class=n>upgrade</span> <span class=s2>&#34;apache-beam[gcp]&#34;</span>
</span></span><span class=line><span class=cl><span class=n>python3</span> <span class=n>movie_pipeline</span><span class=o>.</span><span class=n>py</span> <span class=o>--</span><span class=nb>input</span><span class=o>-</span><span class=n>basics</span> <span class=s2>&#34;$</span><span class=si>{BUCKET}</span><span class=s2>/title.basics.tsv&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=nb>input</span><span class=o>-</span><span class=n>ratings</span> <span class=s2>&#34;$</span><span class=si>{BUCKET}</span><span class=s2>/title.ratings.tsv&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>output</span> <span class=s2>&#34;$</span><span class=si>{BUCKET}</span><span class=s2>/out&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>runner</span> <span class=n>dataflow</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>project</span> <span class=s2>&#34;$</span><span class=si>{PROJECT}</span><span class=s2>&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>region</span> <span class=s2>&#34;$</span><span class=si>{REGION}</span><span class=s2>&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>temp_location</span> <span class=s2>&#34;$</span><span class=si>{BUCKET}</span><span class=s2>/tmp/&#34;</span> \
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>staging_location</span> <span class=s2>&#34;$</span><span class=si>{BUCKET}</span><span class=s2>/binaries/&#34;</span> <span class=c1>#\</span>
</span></span><span class=line><span class=cl><span class=c1>#--num_workers 4</span></span></span></code></pre></td></tr></table></div></div><p>It will, however, fail on <code>Python 3.8</code> with<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Exception: Dataflow only supports Python versions <span class=m>2</span> and 3.5+, got: <span class=o>(</span>3, 8<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></p><p>So use an older <code>Python</code> version here, <code>3.7</code> works well.</p><p>While the job is running, it&rsquo;ll look like this:
<img src=images/py_dataflow_in_progress.png alt=py_dataflow_in_progress.png></p><p>And once completed, something like this:
<img src=images/py_dataflow_complete.png alt=py_dataflow_complete.png></p><h3 id=dataflow-with-go>Dataflow with Go</h3><p><em>This section will walk you through the full exploration and development process, including dead-ends to illustrate some
of the challenges I&rsquo;ve faced. If you are interested in the solution, jump to
the <a href=#finally-running-on-dataflow>last section</a>
.</em></p><p>For <code>go</code>, we need to build and run it with an authenticated <code>gcloud sdk</code>.</p><p>Fist, ensure all custom <code>structs</code> are registered in <code>init()</code>, similar to what you would do with <code>Kryo</code> in <code>Spark</code> with
<code>Scala</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>ratingFn</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>movieFn</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>targetMovie</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>And build and run:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go build movie_pipeline.go
</span></span><span class=line><span class=cl>./movie_pipeline --input-basics <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BUCKET</span><span class=si>}</span><span class=s2>/title.basics.tsv&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--input-ratings <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BUCKET</span><span class=si>}</span><span class=s2>/title.ratings.tsv&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--output <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BUCKET</span><span class=si>}</span><span class=s2>/out&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--runner dataflow <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--project <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--region <span class=s2>&#34;</span><span class=si>${</span><span class=nv>REGION</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--temp_location <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BUCKET</span><span class=si>}</span><span class=s2>/tmp/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--staging_location <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BUCKET</span><span class=si>}</span><span class=s2>/binaries/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--worker_harness_container_image<span class=o>=</span>apache/beam_go_sdk:latest <span class=c1>#\</span>
</span></span><span class=line><span class=cl><span class=c1>#--num_workers 4</span></span></span></code></pre></td></tr></table></div></div></p><p>But it won&rsquo;t run <strong>when trying to use the <code>Side Input</code> with a <code>map</code> route</strong>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>panic: Failed to encode custom coder <span class=k>for</span> <span class=nb>type</span> json. Make sure the <span class=nb>type</span> was registered before calling beam.Init. For
</span></span><span class=line><span class=cl>example: beam.RegisterType<span class=o>(</span>reflect.TypeOf<span class=o>((</span>*TypeName<span class=o>)(</span>nil<span class=o>))</span>.Elem<span class=o>())</span></span></span></code></pre></td></tr></table></div></div></p><h3 id=registering-types-for-dataflow>Registering types for Dataflow</h3><p>The obvious route here is to simply register the type. However, I&rsquo;ve encountered some nasty issues with registering
Types in Beam.</p><blockquote><p>RegisterType inserts &ldquo;external&rdquo; types into a global type registry to bypass serialization and preserve full method
information. It should be called in init() only.
TODO(wcn): the canonical definition of &ldquo;external&rdquo; is in v1.proto. We need user facing copy for this important concept.
<a href=https://godoc.org/github.com/apache/beam/sdks/go/pkg/beam#RegisterType target=_blank rel="nofollow noopener noreferrer">https://godoc.org/github.com/apache/beam/sdks/go/pkg/beam#RegisterType</a></p></blockquote><p>We can try to register the <code>map</code> as such:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// ..</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>m</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span>
</span></span><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>m</span><span class=p>).</span><span class=nf>Elem</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Yields:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>panic</span><span class=p>:</span> <span class=nx>Failed</span> <span class=nx>to</span> <span class=nx>encode</span> <span class=nx>custom</span> <span class=nx>coder</span> <span class=k>for</span> <span class=kd>type</span> <span class=nx>json</span><span class=p>.</span> <span class=nx>Make</span> <span class=nx>sure</span> <span class=nx>the</span> <span class=kd>type</span> <span class=nx>was</span> <span class=nx>registered</span> <span class=nx>before</span> <span class=nx>calling</span> <span class=nx>beam</span><span class=p>.</span><span class=nx>Init</span><span class=p>.</span> <span class=nx>For</span>
</span></span><span class=line><span class=cl><span class=nx>example</span><span class=p>:</span> <span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>TypeName</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>Full</span> <span class=kt>error</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nx>encoding</span> <span class=nx>custom</span> <span class=nx>coder</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>main</span><span class=p>.</span><span class=nx>ratingFn</span><span class=p>[</span><span class=nx>json</span><span class=p>]</span> <span class=k>for</span> <span class=kd>type</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>main</span><span class=p>.</span><span class=nx>ratingFn</span>
</span></span><span class=line><span class=cl><span class=nx>unencodable</span> <span class=kd>type</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>main</span><span class=p>.</span><span class=nx>ratingFn</span></span></span></code></pre></td></tr></table></div></div></p><p>Of course we can try to register a <code>map</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>beam</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>MapOf</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>),</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>ratingFn</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>()))</span></span></span></code></pre></td></tr></table></div></div></p><p>But that did not have the desired effect. Why?</p><p>Digging into the <code>go</code> SDK source, I found the following function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// TypeKey returns the external key of a given type. Returns false if not a</span>
</span></span><span class=line><span class=cl><span class=c1>// candidate for registration.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TypeKey</span><span class=p>(</span><span class=nx>t</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%v =&gt; PckPath: %v Name: %v Kind: %v\n&#34;</span><span class=p>,</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nf>PkgPath</span><span class=p>(),</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Kind</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nf>PkgPath</span><span class=p>()</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Name</span><span class=p>()</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>false</span> <span class=c1>// no pre-declared or unnamed types</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%v.%v&#34;</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nf>PkgPath</span><span class=p>(),</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Name</span><span class=p>()),</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>I&rsquo;ve added the <code>fmt.Printf</code> for debugging.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>main.ratingFn <span class=o>=</span>&gt; PckPath: main Name: ratingFn Kind: struct
</span></span><span class=line><span class=cl>main.movieFn <span class=o>=</span>&gt; PckPath: main Name: movieFn Kind: struct
</span></span><span class=line><span class=cl>main.targetMovie <span class=o>=</span>&gt; PckPath: main Name: targetMovie Kind: struct
</span></span><span class=line><span class=cl>map<span class=o>[</span>string<span class=o>]</span>main.ratingFn <span class=o>=</span>&gt; PckPath:  Name:  Kind: map
</span></span><span class=line><span class=cl>panic: invalid registration type: map<span class=o>[</span>string<span class=o>]</span>main.ratingFn</span></span></code></pre></td></tr></table></div></div><p>This function checks whether the registered type is actually a custom type; a <code>map</code> is not. <code>PckPath</code> and <code>Name</code> are
never set, as <code>map</code> is not a custom type that can be registered through <code>reflection</code>.</p><p>Going
through <a href="https://issues.apache.org/jira/browse/BEAM-6652?jql=project%20%3D%20BEAM%20AND%20component%20%3D%20sdk-go%20AND%20text%20~%20%22map%22" target=_blank rel="nofollow noopener noreferrer">Jira</a>
,
I find this <a href=https://github.com/apache/beam/pull/7857 target=_blank rel="nofollow noopener noreferrer">PR</a>
, leading me
to <a href=https://github.com/lostluck/beam/blob/master/sdks/go/pkg/beam/core/typex/class_test.go#L55 target=_blank rel="nofollow noopener noreferrer">this</a>
unit test -
letting me to believe that the <code>go</code> SDK does not allow for <code>maps</code> with custom types.</p><p>Can we use a <code>list</code> for the <code>Side Input</code> instead to make our lives easier? I guess you know the answer - but let&rsquo;s talk
debugging, since we&rsquo;re at it.</p><h3 id=perf-tools---profiling-go>Perf Tools - Profiling <code>Go</code></h3><p>Let&rsquo;s quickly use <a href=https://blog.golang.org/pprof target=_blank rel="nofollow noopener noreferrer"><code>pprof</code></a>
to profile what&rsquo;s going on under the hood if we were to use a
<code>list</code> instead of a <code>map</code>.</p><p>For this test, I&rsquo;m using a file with 5,000,000 rows, combined clocking in at about ~500MB.</p><p>First, run the job after following the instructions to add additional <code>flags</code> for the profiler:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run movie_pipeline.go --input-basics ../data/title.basics.5M.tsv --input-ratings ../data/title.ratings.5M.tsv
</span></span><span class=line><span class=cl>--output ./test.txt -cpuprofile ../profiler/cpu.out -memprofile ../profiler/mem.out</span></span></code></pre></td></tr></table></div></div></p><p>This job took <em>84 Minutes locally</em>, despite having an Intel i7-9750H, 16GB of DDR4 memory, and an M.2 NVMe SSD at its
disposal.</p><p>Listen to your poor Laptop sound like a Jet Engine, and print the results:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go tool pprof --svg ./cpu.out &gt; cpu.svg
</span></span><span class=line><span class=cl>go tool pprof --svg ./mem.out &gt; mem.svg</span></span></code></pre></td></tr></table></div></div></p><p>And that is the result:
<img src=images/cpu.png alt=cpu></p><p>We can see that the <code>combineMovieRatings</code>, the inefficient list-iteration, took the majority of the time - and from
monitoring <code>htop</code>, I can tell you that the job used a single thread the entire time.</p><p>Now, seeing that iterating a list is very inefficient should not be a surprise - but that in combination with the single
threaded execution (which I believe to be caused by the <code>Splittable DoFn</code> issue), is causing a massive runtime spike.</p><h3 id=a-journey-to-a-custom-coder>A journey to a custom coder</h3><p>After more digging through Jira and GitHub Pull Requests, I stumbled
upon <a href=https://godoc.org/github.com/apache/beam/sdks/go/pkg/beam#Coder target=_blank rel="nofollow noopener noreferrer">Custom Coders</a>
and
their <a href=https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/runtime/coderx/string.go target=_blank rel="nofollow noopener noreferrer">usage for internal Types</a>
.</p><p>I had the brilliant idea to register a custom coder for our map type:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewCustomMap</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>coder</span><span class=p>.</span><span class=nx>CustomCoder</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>coder</span><span class=p>.</span><span class=nf>NewCustomCoder</span><span class=p>(</span><span class=s>&#34;customMap&#34;</span><span class=p>,</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>MapOf</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>),</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>((</span><span class=o>*</span><span class=nx>ratingFn</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)).</span><span class=nf>Elem</span><span class=p>()),</span>
</span></span><span class=line><span class=cl><span class=nx>encCustomMap</span><span class=p>,</span> <span class=nx>decCustomMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>encCustomMap</span><span class=p>(</span><span class=nx>v</span> <span class=nx>typex</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>dat</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>dat</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>decCustomMap</span><span class=p>(</span><span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=nx>typex</span><span class=p>.</span><span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Unfortunately, <a href=https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/forward.go#L95 target=_blank rel="nofollow noopener noreferrer"><code>RegisterCoder</code></a>
looks like
this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RegisterCoder</span><span class=p>(</span><span class=nx>t</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span> <span class=nx>encoder</span><span class=p>,</span> <span class=nx>decoder</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>runtime</span><span class=p>.</span><span class=nf>RegisterType</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>runtime</span><span class=p>.</span><span class=nf>RegisterFunction</span><span class=p>(</span><span class=nx>encoder</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>runtime</span><span class=p>.</span><span class=nf>RegisterFunction</span><span class=p>(</span><span class=nx>decoder</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>coder</span><span class=p>.</span><span class=nf>RegisterCoder</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>encoder</span><span class=p>,</span> <span class=nx>decoder</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>And hence, also calls <code>RegisterType(t)</code>, which will once again fail to register our type or Coder.</p><h3 id=map---json---map>Map -> JSON -> Map</h3><p>While there&rsquo;s a decent change I am misinterpreting all the above <code>go</code> code and <code>Jira</code> tickets, my next approach was to
do the <code>json</code> parsing myself.</p><p>First, instead of returning a map, we return <code>[]byte</code>, which returns a <code>json</code> string:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeRatingsMap</span><span class=p>(</span><span class=nx>rr</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>ratings</span> <span class=p>[]</span><span class=nx>ratingFn</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>([]</span><span class=kt>byte</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>r</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ratings</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>tconst</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>jsonMap</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>jsonMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Then, in our combination function, we <code>unmarshall</code> that data into a <code>map[string]ratingFn</code>.<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>combineMoviesRatings</span><span class=p>(</span><span class=nx>movie</span> <span class=nx>movieFn</span><span class=p>,</span> <span class=nx>ratings</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>emit</span> <span class=kd>func</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>ratingsMap</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ratingFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>ratings</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ratingsMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ratingsMap</span><span class=p>[</span><span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>emit</span><span class=p>(</span><span class=nx>targetMovie</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span><span class=p>:</span>             <span class=nx>movie</span><span class=p>.</span><span class=nx>tconst</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>titleType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span><span class=p>:</span>   <span class=nx>movie</span><span class=p>.</span><span class=nx>primaryTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span><span class=p>:</span>  <span class=nx>movie</span><span class=p>.</span><span class=nx>originalTitle</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>isAdult</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span><span class=p>:</span>      <span class=nx>movie</span><span class=p>.</span><span class=nx>startYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span><span class=p>:</span>        <span class=nx>movie</span><span class=p>.</span><span class=nx>endYear</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span><span class=p>:</span> <span class=nx>movie</span><span class=p>.</span><span class=nx>runtimeMinutes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span><span class=p>:</span>         <span class=nx>movie</span><span class=p>.</span><span class=nx>genres</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span><span class=p>:</span>  <span class=nx>r</span><span class=p>.</span><span class=nx>averageRating</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span><span class=p>:</span>       <span class=nx>r</span><span class=p>.</span><span class=nx>numVotes</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Now, unfortunately, the <code>marshalling</code> needs to be done on every step, which did change the local performance numbers
quite drastically:</p><p><img src=images/cpu-json.png alt=cpu-json.png></p><p>As you can see, <code>json (*decodeState)</code> and <code>mapassign</code> cause a massive overhead for the job and, at least on the
<code>DirectRunner</code>, this is <strong>not a viable alternative</strong>.</p><h3 id=back-to-the-drawing-board>Back to the drawing board</h3><p>At this point, we have to re-visit <code>CoGroupByKey</code> or other options; these issues do, however, show some of the more
odd (and, I might add, completely undocumented) issues and shortfalls of the <code>go</code> SDK.</p><p>It is debatable to say a <code>Side Input</code> is a <em>better</em> solution than a <code>CoGroupByKey</code>, but in my case, I was unable to use
a <code>map</code> as a <code>Side Input</code> in general.</p><h3 id=finally-running-on-dataflow>Finally running on Dataflow</h3><p>After switching back to <code>CoGroupByKey</code>, finally, these changes allow me to submit the job to <code>Dataflow</code>. Keep in mind
that the <em><code>go</code> SDK is not officially supported by DataFlow yet</em>.</p><p>Here, we can also add another output for <code>BigQuery</code> by adding metadata to our <code>struct</code>:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>targetMovie</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span> <span class=kt>string</span> <span class=s>`bigquery:&#34;Id&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>TitleType</span> <span class=kt>string</span> <span class=s>`bigquery:&#34;TitleType&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>PrimaryTitle</span> <span class=kt>string</span> <span class=s>`bigquery:&#34;PrimaryTitle&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>OriginalTitle</span> <span class=kt>string</span> <span class=s>`bigquery:&#34;OriginalTitle&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>IsAdult</span> <span class=kt>bool</span>   <span class=s>`bigquery:&#34;IsAdult&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>StartYear</span> <span class=kt>int64</span>  <span class=s>`bigquery:&#34;StartYear&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>EndYear</span> <span class=kt>int64</span>  <span class=s>`bigquery:&#34;EndYear&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>RuntimeMinutes</span> <span class=kt>int64</span>  <span class=s>`bigquery:&#34;RuntimeMinutes&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>Genres</span> <span class=kt>string</span> <span class=s>`bigquery:&#34;Genres&#34;`</span>
</span></span><span class=line><span class=cl><span class=c1>// Ratings</span>
</span></span><span class=line><span class=cl><span class=nx>AverageRating</span> <span class=kt>float64</span> <span class=s>`bigquery:&#34;AverageRating&#34;`</span>
</span></span><span class=line><span class=cl><span class=nx>NumVotes</span> <span class=kt>int64</span>   <span class=s>`bigquery:&#34;NumVotes&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>And writing to BQ:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=o>*</span><span class=nx>bq</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>project</span> <span class=o>:=</span> <span class=nx>gcpopts</span><span class=p>.</span><span class=nf>GetProject</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>bigqueryio</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>project</span><span class=p>,</span> <span class=o>*</span><span class=nx>bq</span><span class=p>,</span> <span class=nx>combined</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></p><p>Once, submitted, we&rsquo;ll see our DAG:
<img src=images/go_dataflow.png alt=go_dataflow></p><h3 id=splittable-dofns>Splittable DoFns</h3><p><strong>Disclaimer</strong>: The <code>go</code> SDK might lack behind <code>Python</code>&rsquo;s and <code>Java</code>&rsquo;s performance with use cases where <em>large files
need to be loaded</em>.</p><p>This is due to the fact that <strong>the <code>go</code> SDK does not
support <a href=https://beam.apache.org/blog/splittable-do-fn/ target=_blank rel="nofollow noopener noreferrer">Splittable DoFns</a>
</strong>.
See <a href=https://issues.apache.org/jira/browse/BEAM-3301 target=_blank rel="nofollow noopener noreferrer">BEAM-3301</a>
for reference.</p><h3 id=dataflow-performance>Dataflow Performance</h3><p>When comparing performance, we&rsquo;ll look at all 3 approaches:</p><ol><li>Using a simple list as <code>Side Input</code></li><li>Using a <code>dict</code> as <code>Side Input</code> <em>(Python only)</em></li><li>Using <code>CoGroupByKey</code></li></ol><p><img src=images/dataflow_perf.png alt=dataflow_perf.png></p><p>I&rsquo;ve actually had to calculate the <code>list</code> performance on Python, as the job was still running after ~2hrs, with ~8-15
elements/s. I&rsquo;ve approximated the runtime by looking at the expected output from the <code>CoGroupByKey</code> run and the elapsed
time, so the real numbers might be worse!</p><p>This falls in-line with what we&rsquo;ve seen on the <code>DirectRunner</code> - <code>go</code> is faster, even though not as much as &ldquo;regular&rdquo;
<code>go</code> vs <code>Python</code> code in the last Mandelbrot example. We couldn&rsquo;t compare the <code>dict</code>/<code>map</code> logic, as this only ran on
the <code>DirectRunner</code>.</p><p><em>[0] I am not sure why the <code>go</code> SDK does not produce a &ldquo;Records/s&rdquo; metric</em></p><h3 id=performance-summary>Performance Summary</h3><p>Last time, <code>go</code> was almost x45 faster than <code>Python</code> in our <code>Mandelbrot</code> benchmark.</p><p>This time, this is how the summary looks:</p><table><thead><tr><th>Language</th><th>Implementation</th><th>Input Lines</th><th>Runner</th><th>Time (s)</th><th>Improvement</th></tr></thead><tbody><tr><td>Python</td><td>WordCount</td><td>7,000,000</td><td>DirectRunner</td><td>2269.39</td><td>-</td></tr><tr><td>go</td><td>WordCount</td><td>7,000,000</td><td>DirectRunner</td><td>152.79</td><td>1485%</td></tr><tr><td>Python</td><td>As Map/Dict</td><td>100,000</td><td>DirectRunner</td><td>20.46</td><td>-</td></tr><tr><td>go</td><td>As Map/Dict</td><td>100,000</td><td>DirectRunner</td><td>2.04</td><td>1003%</td></tr><tr><td>Python</td><td>As Map/Dict</td><td>1,000,000</td><td>DirectRunner</td><td>195.9</td><td>-</td></tr><tr><td>go</td><td>As Map/Dict</td><td>1,000,000</td><td>DirectRunner</td><td>7.69</td><td>2547%</td></tr><tr><td>Python</td><td>CoGroupByKey</td><td>100,000</td><td>DirectRunner</td><td>37.874</td><td>-</td></tr><tr><td>go</td><td>CoGroupByKey</td><td>100,000</td><td>DirectRunner</td><td>2.72</td><td>1392%</td></tr><tr><td>Python</td><td>CoGroupByKey</td><td>1,000,000</td><td>DirectRunner</td><td>377.25</td><td>-</td></tr><tr><td>go</td><td>CoGroupByKey</td><td>1,000,000</td><td>DirectRunner</td><td>15.53</td><td>2429%</td></tr><tr><td>Python</td><td>As List</td><td>7,000,000</td><td>Dataflow (4)</td><td>(>2 hrs)</td><td>-</td></tr><tr><td>go</td><td>AS List</td><td>7,000,000</td><td>Dataflow (4)</td><td>5580</td><td>-%</td></tr><tr><td>Python</td><td>As Map/Dict</td><td>7,000,000</td><td>Dataflow (4)</td><td>840</td><td>-</td></tr><tr><td>go</td><td>As Map/Dict</td><td>7,000,000</td><td>Dataflow (4)</td><td>(incompatible)</td><td>-%</td></tr><tr><td>Python</td><td>CoGroupByKey</td><td>7,000,000</td><td>Dataflow (4)</td><td>395</td><td>-</td></tr><tr><td>go</td><td>CoGroupByKey</td><td>7,000,000</td><td>Dataflow (4)</td><td>227</td><td>174%</td></tr></tbody></table><p>The average performance gain, across all runners and use cases (exluding 100 records due to overhead and the
approximated runtime) is <strong>1290.19%</strong> - and if we were to take the approximation from the <code>list</code> runtime, we&rsquo;re looking
at <em>1351.40%</em>, even though that is not really fair.</p><p>In any case, this is truely impressive.</p><h2 id=conclusion>Conclusion</h2><p>What have we learned?</p><h3 id=dynamic-vs-static-typing--dict-vs-struct>Dynamic vs. Static Typing & <code>dict</code> vs. <code>struct</code></h3><p>This part, while tremendously subjective, got me thinking quite a bit. When I first started digging into Part 1, it
seemed obvious to me that <code>Python</code>&rsquo;s lack of static typing tends to be a curse, rather than a blessing, more often than
not. The amount of times I had to spend long nights to figure out why on earth a job (be that <code>Beam</code>, <code>Spark</code>, <code>Pandas</code>,
<code>Dask</code>, or anything else) does not do what I want it to or, more pressingly, when I&rsquo;m getting feedback from users that
their data looks &ldquo;off&rdquo;, it was so frequently caused by issues with types.</p><p>I&rsquo;ve elaborated on it in part 1 - Python does not enforce typing. I often result to external libraries, like <code>numpy</code>, to
write classes that force typing using external configurations when dealing with data pipelines. This might follow a
logic like &ldquo;Your dict should have the attribute <code>averageTemp</code> (<code>if 'averageTemp' in dict</code>), and that is a <code>FLOAT64</code>.
<code>FLOAT64</code> maps to numpy&rsquo;s <code>np.float64</code>; to ensure it is actually <code>FLOAT64</code>, we&rsquo;ll try a parse at some point of the job;
if that fails, silently catch it using <code>except</code> and set it to <code>None</code>&rdquo;.</p><p>In <code>go</code>, on the other hand, I cannot comfortably do that. I am forced to abide to structures and types - I can&rsquo;t even
set a <code>string</code> to <code>nil</code>, even though I might be very used to it.</p><p>Now, what is better? Well, I believe it to be a matter of perspective on style and design. While I find &ldquo;production&rdquo;
grade jobs to often be difficult in Python, due to the above edge cases and workarounds (keep in mind: if my data does
not follow the format dictated by the database, I am the one at fault!), can be a challenge.</p><p>At the same time, it took me <em>personally</em> a lot longer to write my jobs in <code>go</code> than it did in <code>Python</code> - because I
needed to think about what I was going to do a lot more. In often treat <code>Python</code> like I treat <code>bash</code> or <code>zsh</code> - type
something in, hope it works. Leading me to&mldr;</p><h3 id=compiler>Compiler</h3><p>&mldr;the compiler. The <code>go</code> compiler is a thing I&rsquo;ve learned to both hate and adore. Since I haven&rsquo;t mentioned it, let me
tell you what the compiler (or rather, the <code>go</code> toolchain) does, using a few select examples:</p><ol><li>You cannot have unused variables</li><li>You cannot have unused imports</li><li>You cannot use the wrong types</li></ol><p>And by <code>cannot</code> I mean: &ldquo;Neither <code>go run</code> nor <code>go build</code> will produce a binary&rdquo;.</p><p>Seems reasonable, right? Well - piggybacking on my <code>Python as bash</code> comment, I find it both helpful and tedious at the
same time. Writing <code>go</code> code is like writing <code>Python</code> code with <code>pylint</code> on high-alert - it won&rsquo;t let you do anything
that might make the compilers life uncomfortable, while at the same time, ensuring what you are producing will actually
work and not have side effects.</p><p>At the same time, specific to <code>Dataflow</code>, it obviously won&rsquo;t catch anything tool-specific - for instance, not
registering classes in <code>init()</code> only becomes an issue once you submit your job.</p><p><code>Python</code>, on the other hand, lets me write code that gets a 1/10 <code>pyLint</code> score and that can be future me&rsquo;s problem.</p><h3 id=readability>Readability</h3><p>I love <code>Beam</code>&rsquo;s syntax in <code>Python</code>. Once you get over how &ldquo;odd&rdquo; it looks, it really is a beautiful way to build a <code>DAG</code>
with something that almost resembles pseudo-code.</p><p><code>go</code>&rsquo;s approach is a lot more academic. It follows a standard language flow - each function returns a <code>PCollection</code>.
This is a lot more intuitive, but I find it looses the benefits of <code>Python</code>&rsquo;s &ldquo;DAG-as-code&rdquo; logic.</p><p>But I&rsquo;ll let you judge for yourself - check out the full code for both <code>Python</code> and <code>go</code>
on <a href=https://github.com/vim89/beam-examples target=_blank rel="nofollow noopener noreferrer">GitHub</a>
.</p><h3 id=splittable-dofns--performance>Splittable DoFns & Performance</h3><p>The performance gain in <code>go</code> was massive and, quite honestly, unexpected. An improvement of, on average, <em>1290.19%</em> is
nothing to scoff at.</p><p><code>Splittable DoFns</code>, on the other ahnd, is in fact a big deal - if not even a deal breaker and makes this exercise mostly
academic in nature, once we move past relatively small data sets and start talking multiple GB or TB.</p><h3 id=documentation>Documentation</h3><p>This is one of my biggest gripes with the <code>go</code> SDK and I feel bad by complaining, because absolutely nothing is stopping
me from committing to it (besides time).</p><p>The <code>Beam</code> docs for <code>go</code> are very lackluster - a lot of functionality and examples are only available for <code>Python</code> and
<code>Java</code>. Finding examples, logic, and overall architecture details around <code>go</code> is challenging, to say the least. I mostly
relied on the <code>godocs</code> and reading a fair bit of source code.</p><p>The write-up above should be proof of this - there were a lot of dead ends I encountered.</p><p>My process when working with the <code>go</code> SDK looked a little something like this:</p><ol><li>Is it on Beam&rsquo;s website? (Usually no)</li><li>Is there an example with comments in there? I cloned the repo and used <code>grep</code> to search for keyword; there is no good
overview of examples, and the ones provided often don&rsquo;t have comments</li><li>Is it in the <code>godocs</code>? If so, do they give examples or explain how to use the funcionality? (See the <code>coder</code> dead-end
above)</li><li>Read the <code>go</code> SDK source code</li></ol><p>Needless to say, there are almost zero Google / StackOverflow results to be found.</p><h3 id=compatibility>Compatibility</h3><p>I&rsquo;ve mentioned this in Part 1 already, but given the experimental nature of the <code>go</code> SDK, the compatibility with <code>Beam</code>
features and <code>Runners</code> obviously is not nearly as good as it is in <code>Python</code> or <code>Java</code>. However, for simple pipelines and
using <code>Dataflow</code> as a runner, <code>go</code> covers the basics for sure. You do lose some of the benefits I&rsquo;ve mentioned in the
introduction, however - fewer runners mean less options.</p><h2 id=so-what>So What?</h2><p><code>go</code> is a fun language to play with, but after spending many hours on both writing these articles, playing with the
code, documentation, and environments, I simply cannot recommend using <code>go</code> for a <code>Beam</code> pipeline at this point - at
least not as a blanket statement.</p><p>Sure - it has advantages over <code>Python</code>, the language itself is clear, well documented, and fast.</p><p>However, the lack of functionality once you move past standard use case, <code>Splittable DoFns</code> issue, documentation, and
compatible environments make using <code>Python</code> (or <code>Java</code>) as a default a lot more reasonable. While someone who is a lot
more familiar with the <code>go</code> SDK for <code>Beam</code> could surely iron out some of my issues - like the <code>map</code> question above -
there are still to many things which make using <code>go</code> in production for a <code>Dataflow</code> pipeline questionable at least.</p><p>For simpler pipelines, however - I believe the performance gain to be worth the other trade offs, if you can live with
an officially not-yet-supported runner (<code>Dataflow</code>).</p><p>That being said, I will surely closely monitor the progress of the <code>Beam</code> SDK and, given the chance, hopefully commit to
it in the future - because <code>go</code> is too interesting a language to just ignore.</p><p><em>All development and benchmarking was done under GNU/Linux [PopOS! 20.04 on Kernel 5.4] with 12 Intel i7-9750H vCores @
4.5Ghz and 16GB RAM on a 2019 System76 Gazelle Laptop, using Dataflows Go Runner in Version 0.5</em></p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#apache-beam--google-dataflow>Apache Beam & Google Dataflow</a></li><li><a href=#why-beam-is-interesting>Why Beam is interesting</a></li><li><a href=#core-concepts>Core Concepts</a><ol><li><a href=#pipeline>Pipeline</a></li><li><a href=#pcollections>PCollections</a></li><li><a href=#transforms>Transforms</a></li><li><a href=#schemas>Schemas</a></li><li><a href=#io>I/O</a></li><li><a href=#runners>Runners</a></li></ol></li><li><a href=#the-use-case-for-a-sample-job>The Use Case for a Sample Job</a><ol><li><a href=#drawing-the-design>Drawing the design</a></li><li><a href=#getting-data>Getting data</a></li></ol></li><li><a href=#creating-the-pipeline>Creating the Pipeline</a><ol><li><a href=#python>Python</a></li><li><a href=#go>Go</a></li></ol></li><li><a href=#reading--parsing-data>Reading & Parsing Data</a><ol><li><a href=#python-1>Python</a></li><li><a href=#go-1>Go</a></li></ol></li><li><a href=#transforming-data>Transforming data</a><ol><li><a href=#python-2>Python</a></li><li><a href=#go-2>Go</a></li></ol></li><li><a href=#filtering-data>Filtering data</a><ol><li><a href=#python-3>Python</a></li><li><a href=#go-3>Go</a></li></ol></li><li><a href=#side-inputs-cogroupbykey-and-joins>Side Inputs, CoGroupByKey, and Joins</a></li><li><a href=#cogroupbykey-1>CoGroupByKey</a><ol><li><a href=#python-4>Python</a></li><li><a href=#go-4>Go</a></li></ol></li><li><a href=#side-inputs>Side Inputs</a><ol><li><a href=#python-5>Python</a></li><li><a href=#go-5>Go</a></li></ol></li><li><a href=#io-1>I/O</a><ol><li><a href=#python-6>Python</a></li><li><a href=#go-6>Go</a></li></ol></li><li><a href=#directrunner-locally>DirectRunner (locally)</a><ol><li><a href=#benchmarking>Benchmarking</a></li><li><a href=#a-reference-job>A Reference Job</a></li></ol></li><li><a href=#dataflow-google-cloud>Dataflow (Google Cloud)</a><ol><li><a href=#python-7>Python</a></li><li><a href=#dataflow-with-go>Dataflow with Go</a></li><li><a href=#registering-types-for-dataflow>Registering types for Dataflow</a></li><li><a href=#perf-tools---profiling-go>Perf Tools - Profiling <code>Go</code></a></li><li><a href=#a-journey-to-a-custom-coder>A journey to a custom coder</a></li><li><a href=#map---json---map>Map -> JSON -> Map</a></li><li><a href=#back-to-the-drawing-board>Back to the drawing board</a></li><li><a href=#finally-running-on-dataflow>Finally running on Dataflow</a></li><li><a href=#splittable-dofns>Splittable DoFns</a></li><li><a href=#dataflow-performance>Dataflow Performance</a></li><li><a href=#performance-summary>Performance Summary</a></li></ol></li><li><a href=#conclusion>Conclusion</a><ol><li><a href=#dynamic-vs-static-typing--dict-vs-struct>Dynamic vs. Static Typing & <code>dict</code> vs. <code>struct</code></a></li><li><a href=#compiler>Compiler</a></li><li><a href=#readability>Readability</a></li><li><a href=#splittable-dofns--performance>Splittable DoFns & Performance</a></li><li><a href=#documentation>Documentation</a></li><li><a href=#compatibility>Compatibility</a></li></ol></li><li><a href=#so-what>So What?</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags><ul class=flat><li class=tag-li><a href=../../../tags/go>go</a></li><li class=tag-li><a href=../../../tags/golang>golang</a></li><li class=tag-li><a href=../../../tags/python>python</a></li><li class=tag-li><a href=../../../tags/dataflow>dataflow</a></li><li class=tag-li><a href=../../../tags/beam>beam</a></li><li class=tag-li><a href=../../../tags/google-cloud>google cloud</a></li><li class=tag-li><a href=../../../tags/gcp>gcp</a></li><li class=tag-li><a href=../../../tags/spark>spark</a></li><li class=tag-li><a href=../../../tags/big-data>big data</a></li><li class=tag-li><a href=../../../tags/programming>programming</a></li><li class=tag-li><a href=../../../tags/benchmarking>benchmarking</a></li><li class=tag-li><a href=../../../tags/performance>performance</a></li></ul></div><div class=back><a href=https://github.com/vim89/vitthalmirji.com/blob/master/content/posts/2020/07/a-data-engineering-perspective-on-go-vs-python-part-2/index.md title=github><i data-feather=github></i> Edit this on GitHub</a></div><div class=back><a href=https://vitthalmirji.com/><span aria-hidden=true>← Back</span></a></div><div class=back>Next time, we'll talk about <i>"10 Reasons why gcc SHOULD be re-written in JavaScript - You won't believe #8!"</i></div></div></div><div class="footer wrapper"><nav class=nav><div>2020 © Copyright notice</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>